<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaTrader5.com</title>
    <meta name="theme-color" content="#1a202c">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- External Script Imports (MANDATORY) -->
    <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- QR Code Library for Deposit Page -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ===================================================================
         * 1. XM/MT5 DARK THEME CUSTOM CSS & GLOBAL STYLES
         * =================================================================== */
        :root {
            --bg-dark: #0b1220; /* Deep blue/black MT5 background */
            --bg-card: #141b27;
            --primary-accent: #f0b90b; /* XM/MT5 yellow accent */
            --text-light: #e0e6ed;
            --text-muted: #8892a6;
            --text-success: #10b981;
            --text-danger: #ef4444;
            --header-height: 56px;
            --footer-height: 52px;
        }

        /* Global Reset */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Main App Container for responsive layout */
        #app-container {
            display: flex;
            flex: 1;
            padding-top: var(--header-height);
            padding-bottom: var(--footer-height);
            width: 100%;
            overflow-y: auto;
        }

        /* Fixed Header */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--bg-card);
            border-bottom: 1px solid #1f2937;
            z-index: 50;
        }

        /* Fixed Footer (Mobile Navigation) */
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            background-color: var(--bg-card);
            border-top: 1px solid #1f2937;
            z-index: 50;
        }

        /* PWA Page Routing Container */
        .page {
            display: none;
            width: 100%;
            min-height: 100%;
            overflow-y: auto;
        }

        .page.active {
            display: block;
        }

        /* Custom Button Styles for XM/MT5 feel */
        .btn-primary {
            background-color: var(--primary-accent);
            color: #111827;
            font-weight: 600;
            border-radius: 6px;
            padding: 10px 16px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #e6b007;
        }
        .btn-secondary {
            background-color: #374151;
            color: var(--text-light);
            border-radius: 6px;
            padding: 10px 16px;
        }

        /* Custom scrollbar for trading sections */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }

        /* Desktop MT5 Layout (lg breakpoint) */
        @media (min-width: 1024px) {
            #app-container {
                display: grid;
                grid-template-columns: 280px 1fr; /* Market Watch/Navigator | Trading Area */
                grid-template-rows: 1fr 200px; /* Trading Area | Terminal */
                padding-bottom: 0; /* Footer is hidden on desktop */
            }

            #main-content {
                grid-column: 2 / 3;
                grid-row: 1 / 2;
                overflow: hidden; /* Chart area */
            }

            #market-sidebar {
                grid-column: 1 / 2;
                grid-row: 1 / 3; /* Sidebar spans both rows */
                display: flex;
                flex-direction: column;
                border-right: 1px solid #1f2937;
            }

            #terminal-toolbox {
                grid-column: 2 / 3;
                grid-row: 2 / 3;
                background-color: var(--bg-card);
                border-top: 1px solid #1f2937;
                display: block !important;
                height: 200px;
                overflow-y: hidden;
            }

            #footer {
                display: none; /* Hide mobile footer nav on desktop */
            }

            /* Desktop pages (Charts/Quotes/Trades) will be routed inside #main-content */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Global Notification Banner (Suspension/News) -->
    <div id="notificationBanner" class="fixed top-0 left-0 right-0 z-[100] bg-red-600 text-white p-2 text-center text-sm hidden">
        <span id="notificationMessage"></span>
        <button onclick="app.logic.dismissNotification()" class="ml-4 font-bold">X</button>
    </div>

    <!-- Header (Persistent Across Trade Pages) -->
    <header id="header" class="flex items-center justify-between px-4 lg:px-6">
        <div class="flex items-center gap-4">
            <!-- Global More Menu -->
            <button id="moreMenuBtn" class="p-2 rounded-full hover:bg-gray-700 lg:hidden">
                <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-xl font-bold text-yellow-400">MT5 Trader</h1>
        </div>
        
        <!-- Header Buttons (Single Line, MT5 Style) -->
        <div id="tradeHeaderToolbar" class="flex items-center gap-3 hidden">
            <!-- Add Symbol -->
            <button   onclick="app.logic.loadTradeSymbols(); app.ui.showPage('symbolSelectionPage');"  class="p-2 rounded-full hover:bg-gray-700"   title="Add Symbol">
          <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
         </button>
            <!-- Selected Symbol -->
                
            <div class="flex items-center bg-gray-700 rounded-full px-3 py-1">
                <span id="selectedSymbolDisplay" class="text-sm font-semibold">USD/JPY</span>
            </div>
             <!-- Mailbox Button -->
            <a href="mailto:mt5-base@hotmail.com" class="p-2 rounded-full hover:bg-gray-700" title="Mailbox">
                <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </a>
            <!-- User Profile/Settings -->
            <button onclick="app.ui.showPage('accountDashboardPage');" class="p-2 rounded-full bg-yellow-400 text-gray-900 hover:bg-yellow-500" title="Account">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Global More Menu Dropdown (Hidden by default) -->
    <div id="moreMenuDropdown" class="fixed top-[var(--header-height)] left-0 w-64 bg-gray-800 border border-gray-700 rounded-b-lg shadow-xl z-40 hidden lg:hidden">
        <button onclick="app.ui.showPage('accountDashboardPage'); app.ui.hideMenuDropdown();" class="w-full text-left p-4 hover:bg-gray-700 flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            Account Dashboard
        </button>
        <button onclick="app.logic.loadCoinNews(); app.ui.showPage('newsPage'); app.ui.hideMenuDropdown();" class="w-full text-left p-4 hover:bg-gray-700 flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m-7 13v-2m0-7a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m-2-4h2m-1-4h.01M21 12h-6"></path></svg>
            News & Notifications
        </button>
        <a href="mailto:mt5-base@hotmail.com" class="w-full text-left p-4 hover:bg-gray-700 flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            Mailbox
        </a>
        <button onclick="app.ui.showPage('settingsPage'); app.ui.hideMenuDropdown();" class="w-full text-left p-4 hover:bg-gray-700 flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </button>
        <button onclick="app.logic.logout(); app.ui.hideMenuDropdown();" class="w-full text-left p-4 hover:bg-gray-700 text-red-400 flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            Logout
        </button>
    </div>

    <!-- Main Application Container -->
    <div id="app-container">
        
        <!-- Desktop MT5 Sidebar (Market Watch & Navigator) -->
        <div id="market-sidebar" class="hidden lg:flex p-4 flex-col bg-gray-800 overflow-y-auto custom-scroll">
            <h2 class="text-lg font-semibold mb-3 text-yellow-400">Market Watch</h2>
            <div id="desktopQuotesList" class="space-y-2 flex-1">
                <!-- Quotes will be loaded here via JS -->
            </div>
            
            <h2 class="text-lg font-semibold mt-6 mb-3 text-yellow-400">Navigator</h2>
            <div class="space-y-2 text-sm">
                <button onclick="app.ui.showPage('accountDashboardPage');" class="w-full text-left p-2 rounded-lg hover:bg-gray-700">Account ID: <span id="desktopAccountId">N/A</span></button>
                <button onclick="app.ui.showPage('depositCoinSelectionPage');" class="w-full text-left p-2 rounded-lg hover:bg-gray-700">Deposit</button>
                <button onclick="app.ui.showPage('withdrawalPage');" class="w-full text-left p-2 rounded-lg hover:bg-gray-700">Withdraw</button>
                <button onclick="app.ui.showPage('historyPage');" class="w-full text-left p-2 rounded-lg hover:bg-gray-700">Account History</button>
                <button onclick="app.ui.showPage('newsPage');" class="w-full text-left p-2 rounded-lg hover:bg-gray-700">News & Alerts</button>
            </div>
        </div>

        <!-- Main Content Area (Handles Mobile Full-Screen Pages & Desktop Chart/Trade View) -->
        <main id="main-content" class="flex-1 overflow-y-auto custom-scroll lg:overflow-y-hidden lg:p-0">

            <!-- ===================================================================
             * 2. PAGE DEFINITIONS
             * =================================================================== -->

            <!-- LANDING PAGE (XM Style) -->
            <div id="landingPage" class="page active min-h-[calc(100vh-var(--header-height)-var(--footer-height))] flex items-center justify-center p-4">
                <div class="w-full max-w-lg bg-gray-800 p-8 rounded-xl shadow-2xl space-y-8 text-center">
                    <h2 class="text-3xl font-extrabold text-yellow-400">MT5 Trader Base</h2>
                    <p class="text-gray-400">Trade Crypto, Forex, and Metals with institutional-grade leverage. Fully decentralized and secure front-end.</p>
                    
                    <div class="space-y-4">
                        <button onclick="app.ui.showPage('accountCreationPage');" class="btn-primary w-full text-lg shadow-lg">
                            Create Real Account
                        </button>
                        <button onclick="app.logic.loadSavedAccounts(); app.ui.showPage('loginSelectionPage');" class="btn-secondary w-full text-lg">
                            Login to Existing Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- ACCOUNT CREATION PAGE -->
            <div id="accountCreationPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('landingPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Landing</button>
                <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Create New Account</h2>
                    <p class="text-gray-400 text-sm">Link your Web3 wallet address to establish your unique trading account.</p>

                    <input type="text" id="createWalletAddress" placeholder="Enter Wallet Address (0x... or T...)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    
                    <div class="relative">
                        <button id="networkSelectorBtn" onclick="app.ui.toggleDropdown('networkDropdown')" class="w-full text-left p-3 rounded-lg bg-gray-700 border border-gray-600 flex justify-between items-center">
                            <span id="selectedNetworkText">Select Network</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="networkDropdown" class="absolute z-10 w-full mt-1 bg-gray-800 rounded-lg shadow-xl border border-gray-700 hidden">
                            <!-- Networks List -->
                            <button onclick="app.logic.selectNetwork('BNB Smart Chain (BEP20)');" class="w-full text-left p-3 hover:bg-gray-700 rounded-t-lg">BNB Smart Chain (BEP20)</button>
                            <button onclick="app.logic.selectNetwork('Ethereum');" class="w-full text-left p-3 hover:bg-gray-700">Ethereum</button>
                            <button onclick="app.logic.selectNetwork('Tron (TRC20)');" class="w-full text-left p-3 hover:bg-gray-700 rounded-b-lg">Tron (TRC20)</button>
                        </div>
                    </div>
                    
                    <input type="password" id="createPassword" placeholder="Creation Password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    
                    <button onclick="app.logic.createRealAccount()" class="btn-primary w-full mt-4">
                        Create Real Account
                    </button>
                </div>
            </div>

            <!-- LOGIN SELECTION/PAGE -->
            <div id="loginSelectionPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('landingPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back</button>
                <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Login to Existing Account</h2>

                    <!-- Saved Accounts Dropdown -->
                    <div id="savedAccountsDropdown" class="w-full bg-gray-700 rounded-lg border border-gray-600 hidden">
                        <!-- Accounts list rendered by JS -->
                    </div>

                    <input type="text" id="loginWalletAddress" placeholder="Enter Wallet Address (0x... or T...)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    
                    <div class="relative">
                        <button id="loginNetworkSelectorBtn" onclick="app.ui.toggleDropdown('loginNetworkDropdown')" class="w-full text-left p-3 rounded-lg bg-gray-700 border border-gray-600 flex justify-between items-center">
                            <span id="loginSelectedNetworkText">Select Network</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="loginNetworkDropdown" class="absolute z-10 w-full mt-1 bg-gray-800 rounded-lg shadow-xl border border-gray-700 hidden">
                            <!-- Networks List -->
                            <button onclick="app.logic.selectNetwork('BNB Smart Chain (BEP20)', 'login');" class="w-full text-left p-3 hover:bg-gray-700 rounded-t-lg">BNB Smart Chain (BEP20)</button>
                            <button onclick="app.logic.selectNetwork('Ethereum', 'login');" class="w-full text-left p-3 hover:bg-gray-700">Ethereum</button>
                            <button onclick="app.logic.selectNetwork('Tron (TRC20)', 'login');" class="w-full text-left p-3 hover:bg-gray-700 rounded-b-lg">Tron (TRC20)</button>
                        </div>
                    </div>
                    
                    <input type="password" id="loginPassword" placeholder="Account Password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    
                    <button onclick="app.logic.loginToAccount()" class="btn-primary w-full mt-4">
                        Login
                    </button>
                </div>
            </div>

            <!-- QUOTES PAGE (MT5 Footer Button Default) -->
            <div id="quotesPage" class="page p-4 lg:p-0">
                <h2 class="text-2xl font-bold mb-4 lg:hidden">Quotes</h2>
                <div id="quotesList" class="space-y-2 lg:hidden">
                    <!-- Mobile quotes list rendered here -->
                </div>
            </div>

            <!-- CHARTS PAGE -->
            <div id="chartsPage" class="page flex flex-col h-full overflow-hidden">
                <div class="flex flex-col flex-1 h-full lg:h-auto">
                    <!-- Chart Header Toolbar -->
                    <div class="flex items-center justify-between p-3 bg-gray-800 border-b border-gray-700">
                        <h2 id="chartTitle" class="text-lg font-semibold text-yellow-400">Trading Chart</h2>
                        <div class="flex gap-2">
                             <select id="intervalSelect" onchange="app.logic.updateChartInterval(this.value)" class="bg-gray-700 text-sm p-1 rounded-lg">
                                <option value="1">1m</option>
                                <option value="5">5m</option>
                                <option value="15">15m</option>
                                <option value="60" selected>1h</option>
                                <option value="D">1D</option>
                            </select>
                            <button onclick="app.ui.showOrderTicket()" class="btn-primary py-1 px-3 text-sm">Order</button>
                        </div>
                    </div>

                    <!-- TradingView Widget Container -->
                    <div id="tv_chart_container" class="flex-1 min-h-[400px] lg:min-h-full">
                        <p class="text-center text-gray-500 pt-10">Loading TradingView Chart...</p>
                    </div>
                </div>
            </div>
            
            <!-- TRADES PAGE (Terminal content view on mobile) -->
            <div id="tradesPage" class="page p-4 lg:p-0">
                <h2 class="text-2xl font-bold mb-4 lg:hidden">Open Trades (Terminal)</h2>
                <div id="terminal-content" class="bg-gray-800 rounded-lg p-4 space-y-4">
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-400 border-b border-gray-700 pb-2">
                        <span>Balance: <span id="tradeBalanceDisplay" class="font-semibold text-text-light">$0.00</span></span>
                        <span>Equity: <span id="tradeEquityDisplay" class="font-semibold text-text-success">$0.00</span></span>
                        <span>Margin: <span id="tradeMarginDisplay" class="font-semibold text-text-light">$0.00</span></span>
                        <span>Free Margin: <span id="tradeFreeMarginDisplay" class="font-semibold text-text-light">$0.00</span></span>
                        <span class="col-span-2">Margin Level: <span id="tradeMarginLevelDisplay" class="font-semibold text-text-success">0.00%</span></span>
                    </div>

                    <h3 class="text-lg font-semibold text-yellow-400">Open Positions</h3>
                    <div id="openPositionsList" class="space-y-3">
                        <p class="text-gray-500 text-sm">No active trades.</p>
                    </div>

                    <div id="positionsButtonSection" class="pt-4 flex justify-between gap-4">
                        <button onclick="app.logic.closeAllPositions()" class="btn-secondary w-full text-sm bg-red-600 hover:bg-red-700">Close All Positions</button>
                    </div>
                </div>
            </div>

            <!-- HISTORY PAGE -->
            <div id="historyPage" class="page p-4 lg:p-6">
                <h2 class="text-2xl font-bold mb-4 text-yellow-400">Account History & Activity</h2>
                <div id="activityHistoryList" class="space-y-4">
                    <p class="text-gray-500 text-center">No history yet.</p>
                </div>
            </div>

            <!-- ACCOUNT DASHBOARD PAGE -->
            <div id="accountDashboardPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('quotesPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center lg:hidden"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Trade</button>

                <div class="max-w-3xl mx-auto space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                        <h2 class="text-3xl font-bold text-yellow-400 mb-2">Account Dashboard</h2>
                        <p class="text-gray-400 mb-6">Welcome, Account ID: <span id="accountIdDisplay" class="font-mono text-lg text-text-light">N/A</span></p>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Total Trade Balance</p>
                                <p id="totalTradeBalance" class="text-3xl font-extrabold text-green-400 mt-1">$0.00</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-sm text-gray-400">Account Type</p>
                                <p class="text-xl font-bold mt-1 text-text-light">Real Account</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between gap-3 text-sm border-t border-b border-gray-700 py-4 mb-6">
                            <button onclick="app.ui.showPage('depositCoinSelectionPage')" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700">
                                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Deposit
                            </button>
                            <button onclick="app.ui.showPage('withdrawalPage')" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700">
                                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4m16 0l-4 4m4-4l-4-4"></path></svg>Withdraw
                            </button>
                            <button onclick="app.ui.showModal('Transfer Disabled', 'Transfer functionality is currently undergoing maintenance.');" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>Transfer
                            </button>
                            <button onclick="app.ui.showOrderTicket()" class="flex flex-col items-center p-2 rounded-lg hover:bg-gray-700">
                                <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>Order
                            </button>
                        </div>

                        <!-- Token Holdings -->
                        <h3 class="text-lg font-semibold mb-3">Token Holdings</h3>
                        <div id="tokenHoldingsList" class="space-y-3">
                            <p class="text-gray-500 text-sm">Loading token balances...</p>
                        </div>

                        <!-- User Profile Button -->
                        <div class="mt-8 pt-4 border-t border-gray-700">
                            <button onclick="app.ui.showPage('userProfilePage')" class="btn-secondary w-full">View Full Profile & Security</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- USER PROFILE PAGE -->
            <div id="userProfilePage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('accountDashboardPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Dashboard</button>

                <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6">
                    <h2 class="text-2xl font-bold text-yellow-400">User Profile</h2>
                    
                    <div class="space-y-4">
                        <p class="text-sm text-gray-400">Account ID:</p>
                        <p id="profileAccountId" class="font-mono break-all"></p>
                        <p class="text-sm text-gray-400">Wallet Address:</p>
                        <p id="profileWalletAddress" class="font-mono break-all"></p>
                        <p class="text-sm text-gray-400">Wallet Balance (Simulated Deposit):</p>
                        <p id="profileWalletBalance" class="font-bold text-green-400"></p>
                    </div>

                    <div id="secureAccountSection" class="pt-4 border-t border-gray-700">
                        <button onclick="app.ui.showPage('googleAuthPage');" class="btn-primary w-full">
                            <span id="secureAccountBtnText">Secure Account (2FA Setup)</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- GOOGLE AUTHENTICATOR (2FA) PAGE -->
            <div id="googleAuthPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('userProfilePage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Profile</button>
                
                <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6 text-center" id="authSetupPanel">
                    <h2 class="text-2xl font-bold text-yellow-400">Google Authenticator (2FA)</h2>
                    <p class="text-sm text-gray-400">Account ID: <span id="authAccountId"></span></p>

                    <p class="text-sm">Scan the QR code or manually enter the Secret Key into your authenticator app.</p>
                    
                    <div id="qrcode2FA" class="flex justify-center bg-white p-4 rounded-lg shadow-inner"></div>

                    <p class="text-sm text-gray-400">Secret Key:</p>
                    <div class="flex items-center justify-center gap-2">
                        <span id="authSecretKey" class="font-mono text-lg break-all"></span>
                        <button onclick="app.utils.copyToClipboard('authSecretKey')" class="p-1 rounded-full bg-gray-700 hover:bg-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-7 3h7m-7 3h7m-7 3h7"></path></svg>
                        </button>
                    </div>
                    
                    <input type="text" id="authVerificationCode" placeholder="Enter 6-digit Code" maxlength="6" class="w-full p-3 text-center text-2xl tracking-widest rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400 mt-4">
                    
                    <button onclick="app.logic.verify2FA()" class="btn-primary w-full">Verify Code & Link</button>
                </div>

                <div id="authLinkedPanel" class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6 text-center hidden">
                    <h2 class="text-2xl font-bold text-green-400">2FA is Enabled!</h2>
                    <p class="text-sm text-gray-400">Your account is secured. You will be prompted for a 2FA code on critical actions.</p>
                    <button onclick="app.logic.disable2FA()" class="btn-secondary text-red-400">Disable 2FA</button>
                </div>
            </div>

            <!-- DEPOSIT COIN SELECTION PAGE -->
            <div id="depositCoinSelectionPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('accountDashboardPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back</button>
                <div class="max-w-xl mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-yellow-400">Select Deposit Asset</h2>
                    <input type="text" id="depositSearch" placeholder="Search coin (e.g., BTC, USDT)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    <div id="depositCoinList" class="space-y-3 custom-scroll max-h-[70vh] overflow-y-auto">
                        <p class="text-center text-gray-400 py-4">Loading coins...</p>
                    </div>
                </div>
            </div>

            <!-- DEPOSIT NETWORK SELECTION PAGE -->
            <div id="depositNetworkPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('depositCoinSelectionPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Coin</button>
                <div class="max-w-xl mx-auto space-y-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Deposit <span id="depositCoinName">USDT</span></h2>
                    <p class="text-gray-400">Select the network you will use for your deposit.</p>
                    <div id="networkSelectionList" class="space-y-3">
                        <!-- Network buttons rendered by JS -->
                    </div>
                </div>
            </div>

            <!-- DEPOSIT ADDRESS PAGE -->
            <div id="depositAddressPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('depositNetworkPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Network</button>
                <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6 text-center">
                    <h2 class="text-xl font-bold">Deposit Address (<span id="depositNetworkHeader">Ethereum</span>)</h2>
                    <div id="qrcode" class="flex justify-center bg-white p-4 rounded-lg shadow-inner mx-auto w-48 h-48"></div>
                    
                    <p class="text-sm text-gray-400">Send only <span class="font-bold" id="depositAddressCoinSymbol"></span> to this address:</p>
                    <div class="flex items-center justify-center p-3 bg-gray-700 rounded-lg break-all">
                        <span id="depositAddressDisplay" class="font-mono text-sm">N/A</span>
                        <button onclick="app.logic.copyDepositAddress()" class="ml-2 p-1 rounded-full hover:bg-gray-600">
                            <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-7 3h7m-7 3h7m-7 3h7"></path></svg>
                        </button>
                    </div>

                    <input type="number" id="depositAmountInput" placeholder="Enter Deposit Amount (USD)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400 text-center text-lg mt-4">
                    
                    <button onclick="app.logic.showDepositConfirmationPage()" class="btn-primary w-full">
                        Next: Confirm Deposit
                    </button>
                </div>
            </div>

            <!-- DEPOSIT CONFIRMATION PAGE -->
            <div id="depositConfirmPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('depositAddressPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back</button>
                <div class="max-w-sm mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6">
                    <h2 class="text-xl font-bold text-yellow-400">Confirm Deposit</h2>
                    <p>Amount: <span id="depositConfirmAmount" class="font-bold text-green-400">0.00</span> USD</p>
                    <p class="text-sm text-gray-400">Enter a valid 6-digit verification code to confirm the funds have been sent from your end.</p>
                    
                    <input type="text" id="depositVerificationCode" placeholder="6-digit Verification Code" maxlength="6" class="w-full p-3 text-center text-2xl tracking-widest rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    <p id="depositCodeError" class="text-red-400 text-sm hidden">Error message</p>
                    
                    <button onclick="app.logic.handleDepositConfirmation()" class="btn-primary w-full">
                        Submit & Validate
                    </button>
                </div>
            </div>

            <!-- WITHDRAWAL PAGE (Binance Style) -->
            <div id="withdrawalPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('accountDashboardPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Dashboard</button>
                
                <div class="max-w-xl mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6">
                    <h2 class="text-2xl font-bold text-yellow-400">On-Chain Withdrawal</h2>
                    <p class="text-gray-400 text-sm">Current Balance: <span id="withdrawCurrentBalance" class="font-bold text-green-400">$0.00</span></p>

                    <!-- Withdrawal Address -->
                    <label class="block text-sm font-medium">Withdrawal Address</label>
                    <div class="flex gap-2">
                        <input type="text" id="withdrawalAddressInput" placeholder="Enter recipient address" class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600">
                        <button onclick="app.logic.fillWithdrawalAddress()" class="btn-secondary whitespace-nowrap px-4 py-3 text-xs">Fill from Wallet</button>
                    </div>

                    <!-- Network Selection -->
                    <div class="relative">
                        <label class="block text-sm font-medium mb-1">Select Network</label>
                        <button id="withdrawNetworkSelectorBtn" onclick="app.ui.toggleDropdown('withdrawNetworkDropdown')" class="w-full text-left p-3 rounded-lg bg-gray-700 border border-gray-600 flex justify-between items-center">
                            <span id="withdrawSelectedNetworkText">Select Network</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="withdrawNetworkDropdown" class="absolute z-10 w-full mt-1 bg-gray-800 rounded-lg shadow-xl border border-gray-700 hidden">
                            <!-- Networks List -->
                            <button onclick="app.logic.selectWithdrawNetwork('Ethereum');" class="w-full text-left p-3 hover:bg-gray-700 rounded-t-lg">Ethereum</button>
                            <button onclick="app.logic.selectWithdrawNetwork('Bitcoin');" class="w-full text-left p-3 hover:bg-gray-700">Bitcoin</button>
                            <button onclick="app.logic.selectWithdrawNetwork('BSC');" class="w-full text-left p-3 hover:bg-gray-700">BNB Smart Chain (BSC)</button>
                            <button onclick="app.logic.selectWithdrawNetwork('Tron');" class="w-full text-left p-3 hover:bg-gray-700 rounded-b-lg">Tron (TRC20)</button>
                        </div>
                    </div>
                    
                    <!-- Amount Input -->
                    <label class="block text-sm font-medium">Withdrawal Amount (USD)</label>
                    <div class="flex gap-2">
                        <input type="number" id="withdrawalAmountInput" placeholder="Enter amount" class="flex-1 p-3 rounded-lg bg-gray-700 border border-gray-600">
                        <button onclick="app.logic.setMaxWithdrawal()" class="btn-secondary whitespace-nowrap px-4 py-3 text-xs">Max</button>
                    </div>

                    <p class="text-sm text-gray-400">Gas Fee: <span class="font-bold">0.114 BNB</span> (Fixed)</p>
                    <p id="withdrawalSuspensionMessage" class="text-red-400 font-bold text-center hidden"></p>

                    <button onclick="app.logic.showWithdrawalConfirmation()" class="btn-primary w-full">
                        Withdraw
                    </button>
                </div>
            </div>

            <!-- WITHDRAWAL CONFIRMATION PAGE -->
            <div id="withdrawalConfirmPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('withdrawalPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back</button>
                <div class="max-w-sm mx-auto bg-gray-800 p-6 rounded-xl shadow-xl space-y-6">
                    <h2 class="text-xl font-bold text-yellow-400">Final Confirmation</h2>
                    <p class="text-sm text-gray-400">Enter the 6-digit validation code to authorize the withdrawal.</p>
                    
                    <input type="text" id="withdrawalValidationCode" placeholder="6-digit Validation Code" maxlength="6" class="w-full p-3 text-center text-2xl tracking-widest rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    <p id="withdrawalCodeError" class="text-red-400 text-sm hidden">Error message</p>
                    
                    <button onclick="app.logic.handleWithdrawalConfirmation()" class="btn-primary w-full">
                        Submit
                    </button>
                </div>
            </div>

            <!-- NEWS & NOTIFICATIONS PAGE -->
            <div id="newsPage" class="page p-4 lg:p-6">
                <h2 class="text-2xl font-bold mb-4 text-yellow-400">Market News & Updates</h2>
                <div class="flex justify-between items-center mb-4 p-3 bg-gray-800 rounded-lg">
                    <p class="font-semibold">Receive Daily Market Updates</p>
                    <label class="switch relative inline-block w-12 h-6">
                        <input type="checkbox" id="notificationToggle" class="opacity-0 w-0 h-0" onchange="app.logic.toggleNotifications(this.checked)">
                        <span class="slider round absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-600 rounded-full transition duration-400 before:absolute before:content-[''] before:h-5 before:w-5 before:left-[2px] before:bottom-[2px] before:bg-white before:rounded-full before:transition duration-400"></span>
                    </label>
                    <style>
                        .switch input:checked + .slider { background-color: var(--primary-accent); }
                        .switch input:checked + .slider:before { transform: translateX(20px); }
                    </style>
                </div>
                <div id="newsFeed" class="space-y-4">
                    <p class="text-gray-500 text-center">Loading news feed...</p>
                </div>
            </div>

            <!-- SETTINGS PAGE -->
            <div id="settingsPage" class="page p-4 lg:p-6">
                <h2 class="text-2xl font-bold mb-4 text-yellow-400">Settings</h2>
                <div class="max-w-xl mx-auto space-y-4">
                    <div class="bg-gray-800 p-4 rounded-xl">
                        <p class="font-semibold mb-2">Logout</p>
                        <button onclick="app.logic.logout()" class="btn-secondary text-sm bg-red-600 hover:bg-red-700">Logout of MT5 Trader</button>
                    </div>
                </div>
            </div>

            <!-- SYMBOL SELECTION PAGE -->
            <div id="symbolSelectionPage" class="page p-4 lg:p-6">
                <button onclick="app.ui.showPage('quotesPage');" class="text-sm text-gray-400 hover:text-yellow-400 mb-4 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to Quotes</button>
                <div class="max-w-xl mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-yellow-400">Add Trading Symbols</h2>
                    <input type="text" id="symbolSearchInput" placeholder="Search symbol (e.g., BTC, ETH)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-yellow-400 focus:border-yellow-400">
                    <div id="symbolList" class="space-y-3 custom-scroll max-h-[70vh] overflow-y-auto">
                        <p class="text-center text-gray-400 py-4">Loading tradeable assets...</p>
                    </div>
                </div>
            </div>

            <!-- ORDER TICKET MODAL -->
            <div id="orderTicketModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
                <div class="bg-gray-800 w-full max-w-sm rounded-xl shadow-2xl p-6 space-y-4">
                    <h2 class="text-xl font-bold text-yellow-400">New Order</h2>
                    
                    <div class="flex items-center justify-between">
                        <label>Symbol:</label>
                        <select id="orderSymbol" class="p-2 rounded-lg bg-gray-700 border border-gray-600 w-32" onchange="app.logic.updateChartSymbol(this.value)">
                            <!-- Symbols populated by JS -->
                        </select>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label>Type:</label>
                        <select id="orderType" class="p-2 rounded-lg bg-gray-700 border border-gray-600 w-32">
                            <option>Market Execution</option>
                            <option>Buy Limit</option>
                            <option>Sell Limit</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between">
                        <label>Volume (0.01-0.5):</label>
                        <input type="number" id="orderVolume" value="0.01" step="0.01" min="0.01" max="0.5" class="p-2 rounded-lg bg-gray-700 border border-gray-600 w-32 text-right">
                    </div>

                    <div class="flex items-center justify-between">
                        <label>Trade Duration (Months):</label>
                        <select id="tradeDuration" class="p-2 rounded-lg bg-gray-700 border border-gray-600 w-32">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12">12 Months</option>
                        </select>
                    </div>

                    <input type="number" id="orderStopLoss" placeholder="Stop Loss" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                    <input type="number" id="orderTakeProfit" placeholder="Take Profit" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600">
                    
                    <div class="flex gap-4 pt-2">
                        <button onclick="app.logic.placeTrade('SELL')" class="flex-1 bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-bold">Sell</button>
                        <button onclick="app.logic.placeTrade('BUY')" class="flex-1 bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-bold">Buy</button>
                    </div>
                    
                    <button onclick="app.ui.hideOrderTicket()" class="btn-secondary w-full">Close</button>
                </div>
            </div>

            <!-- GENERIC MODAL -->
            <div id="genericModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
                <div class="bg-gray-800 w-full max-w-xs rounded-xl shadow-2xl p-6 space-y-4 text-center">
                    <h3 id="modalTitle" class="text-xl font-bold text-yellow-400"></h3>
                    <p id="modalMessage" class="text-gray-300"></p>
                    <button onclick="app.ui.hideModal()" class="btn-primary w-full">OK</button>
                </div>
            </div>

        </main>

        <!-- TERMINAL TOOLBOX (Desktop Only) -->
        <div id="terminal-toolbox" class="p-4 hidden overflow-y-auto custom-scroll">
            <h3 class="text-lg font-semibold text-yellow-400 mb-2">Terminal / Toolbox</h3>
            <div class="flex space-x-4 border-b border-gray-700 mb-3">
                <button onclick="app.ui.showTerminalTab('trades')" class="terminal-tab text-sm font-semibold p-2 border-b-2 border-yellow-400 text-yellow-400" data-tab="trades">Trades</button>
                <button onclick="app.ui.showTerminalTab('history')" class="terminal-tab text-sm font-semibold p-2 border-b-2 border-transparent hover:border-gray-500" data-tab="history">History</button>
                <button onclick="app.ui.showTerminalTab('mailbox')" class="terminal-tab text-sm font-semibold p-2 border-b-2 border-transparent hover:border-gray-500" data-tab="mailbox">Mailbox</button>
            </div>
            
            <div id="terminal-trades" class="terminal-panel space-y-3">
                <div class="grid grid-cols-5 gap-2 text-xs font-medium text-gray-400 border-b border-gray-700 pb-1">
                    <span>Account ID: <span id="terminalAccountId">N/A</span></span>
                    <span class="col-span-4 text-right">Balance: <span id="terminalBalance">$0.00</span></span>
                </div>
                <div id="terminalPositionsList" class="space-y-3 max-h-32 overflow-y-auto custom-scroll">
                    <!-- Open positions -->
                    <p class="text-gray-500 text-sm">No active positions.</p>
                </div>
            </div>
            <div id="terminal-history" class="terminal-panel hidden">
                <div id="terminalHistoryList" class="space-y-3 max-h-40 overflow-y-auto custom-scroll">
                    <!-- History list -->
                    <p class="text-gray-500 text-sm">No recent activity.</p>
                </div>
            </div>
            <div id="terminal-mailbox" class="terminal-panel hidden">
                <p class="text-gray-500 text-sm">Your Mailbox is empty.</p>
            </div>
        </div>

    </div>

    <!-- Footer (Mobile Navigation) -->
    <footer id="footer" class="lg:hidden">
        <div class="flex h-full">
            <button onclick="app.ui.showPage('quotesPage'); app.ui.updateFooterActive('quotesPage');" class="footer-btn flex-1 flex flex-col items-center justify-center text-xs active text-yellow-400" data-page="quotesPage">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Quotes
            </button>
            <button onclick="app.ui.showPage('chartsPage'); app.ui.updateFooterActive('chartsPage');" class="footer-btn flex-1 flex flex-col items-center justify-center text-xs text-gray-400 hover:text-yellow-400" data-page="chartsPage">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l2-2m2 2l2-2m2 2l2-2M9 12h6m-6 4h.01M5 12h.01M19 12h.01M6 16h.01M18 16h.01M9 16h.01M15 16h.01"></path></svg>Charts
            </button>
            <button onclick="app.ui.showPage('tradesPage'); app.ui.updateFooterActive('tradesPage');" class="footer-btn flex-1 flex flex-col items-center justify-center text-xs text-gray-400 hover:text-yellow-400" data-page="tradesPage">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path></svg>Trades
            </button>
            <button onclick="app.ui.showPage('historyPage'); app.ui.updateFooterActive('historyPage');" class="footer-btn flex-1 flex flex-col items-center justify-center text-xs text-gray-400 hover:text-yellow-400" data-page="historyPage">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>History
            </button>
            <button onclick="app.logic.loadCoinNews(); app.ui.showPage('newsPage'); app.ui.updateFooterActive('newsPage');" class="footer-btn flex-1 flex flex-col items-center justify-center text-xs text-gray-400 hover:text-yellow-400" data-page="newsPage">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>Messages
            </button>
        </div>
    </footer>

    <!-- ===================================================================
     * 3. JAVASCRIPT LOGIC
     * =================================================================== -->
    <script>
        // --- 3.1. API & CONFIG CONSTANTS ---
        const APP_NAMESPACE = 'mt5TraderAppState';
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const WEB3_API_KEY = "0338f3b98ad211aef5de661cba3f0ead0981460048cfabeee506cdd58a298204";
        const WALLETCONNECT_PROJECT_ID = "cedd3cec8430b2990ce3fe466ecb1a29";
        const INFURA_ID = "c35d1ef971da479b918c9900134867d4";
        const BLOCKCHAIN_EXPLORER_API_KEY = "11256eb482c92bc78682c5635052761bd4bcfa8b";
        const SNOWSCAN_API_KEY = "ATJQERBKV1CI3GVKNSE3Q7RGEJ";
        const SNOWSCAN_API_URL = "https://api.snowscan.xyz/api";

        const DEPOSIT_ADDRESSES = {
            ETHEREUM: "0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130",
            TRON: "TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco",
            BSC: "0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130",
            BITCOIN: "bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu"
        };
        const DEPOSIT_NETWORKS = {
            USDT: ['Ethereum', 'Tron', 'BSC'], BTC: ['Bitcoin'], ETH: ['Ethereum'], BNB: ['BSC'], TRX: ['Tron']
        };
        const DEPOSIT_CODES = [482915, 930472, 158203, 764981, 502319, 847261, 319586, 672450, 248391, 905836, 731258, 629047, 580124, 417902, 896351, 264098, 152983, 309472, 741826, 589320, 620583, 958210, 203874, 742985, 894621, 510293, 673420, 248765, 901632, 437892];
        const WITHDRAWAL_VALID_CODES = ["483921", "175064", "902718", "634285", "217509", "856430", "490127", "731694", "562803", "308417", "941256", "128374", "675820", "203519", "487960", "819432", "356701", "740528"];
        const DAILY_RETURN_RATE = 0.0795; // 7.95%
        const HOURLY_RETURN_RATE = DAILY_RETURN_RATE / 24;
        
        // --- 3.2. GLOBAL STATE (PERSISTED) ---
        let appState = {
            isAuthenticated: false,
            currentAccountId: null,
            currentWalletAddress: null,
            currentNetwork: null,
            passwordHash: null,
            is2FAEnabled: false,
            twoFASecret: null,
            balances: {
                totalUSD: 0.00,
                tradeUSD: 0.00, // Amount available for trading
                equityUSD: 0.00, // Profits from trades
            },
            tokenHoldings: [], // {symbol, amount, usdValue, price}
            activities: [], // Log of deposits, withdrawals, trades
            savedAccounts: [], // List of {accountId, address, network}
            activeTrades: [], // {id, symbol, type, volume, openPrice, openTime, durationMonths, expectedEndTime, margin, pnl, initialMargin}
            withdrawalState: {
                inProgress: false,
                endTime: null, // timestamp for 24h timer
                attempts: 0,
                suspensionEndTime: null, // timestamp for 48h timer
            },
            notificationSettings: {
                enabled: true,
                dismissedNotificationTimestamp: 0,
            },
            // Temporary state for current deposit/withdrawal flow
            currentDeposit: {},
            currentWithdrawal: {},
        };

        // --- 3.3. UTILITIES & STATE MANAGEMENT ---
        const utils = {
            saveState: () => {
                try {
                    localStorage.setItem(APP_NAMESPACE, JSON.stringify(appState));
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            },
            loadState: () => {
                try {
                    const savedState = localStorage.getItem(APP_NAMESPACE);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        // Merge parsed state with defaults to ensure all keys exist
                        appState = { ...appState, ...parsedState };
                        appState.balances = { ...appState.balances, ...parsedState.balances };
                        appState.withdrawalState = { ...appState.withdrawalState, ...parsedState.withdrawalState };
                        appState.notificationSettings = { ...appState.notificationSettings, ...parsedState.notificationSettings };
                        
                        // Convert dates/timestamps back to numbers if necessary
                        if (appState.withdrawalState.endTime && typeof appState.withdrawalState.endTime === 'string') {
                            appState.withdrawalState.endTime = new Date(appState.withdrawalState.endTime).getTime();
                        }
                        if (appState.withdrawalState.suspensionEndTime && typeof appState.withdrawalState.suspensionEndTime === 'string') {
                            appState.withdrawalState.suspensionEndTime = new Date(appState.withdrawalState.suspensionEndTime).getTime();
                        }
                    }
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    // Clear corrupted state
                    localStorage.removeItem(APP_NAMESPACE);
                }
            },
            waitFor: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
            generateAccountId: () => Math.floor(1000000000 + Math.random() * 9000000000).toString(),
            generate2FASecret: () => otplib.authenticator.generateSecret(),
            validate2FA: (secret, token) => otplib.authenticator.check(token, secret),
            copyToClipboard: (elementId) => {
                const text = document.getElementById(elementId).innerText || document.getElementById(elementId).value;
                navigator.clipboard.writeText(text)
                    .then(() => app.ui.showMessage('Copied to clipboard!', 'success'))
                    .catch(() => app.ui.showMessage('Failed to copy address.', 'error'));
            },
            hashPassword: (password) => CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex),
        };

        // --- 3.4. UI/UX MANAGEMENT ---
        const ui = {
            // Client-Side Router
            showPage: (pageId) => {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none'; // Ensure display is set to none
                });
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    targetPage.style.display = 'block';
                    window.scrollTo(0, 0); // Scroll to top on page change
                    
                    // Show/Hide Header Toolbar and Footer based on context
                    const isTradePage = ['quotesPage', 'chartsPage', 'tradesPage', 'historyPage', 'newsPage', 'accountDashboardPage'].includes(pageId);
                    document.getElementById('tradeHeaderToolbar').classList.toggle('hidden', !isTradePage);
                    document.getElementById('footer').classList.toggle('hidden', !appState.isAuthenticated);
                    document.getElementById('header').classList.toggle('hidden', false);

                    // For desktop layout, update chart if needed
                    if (window.innerWidth >= 1024) {
                        if (pageId === 'chartsPage') {
                            // Re-init chart container size on view change
                            app.logic.createTV(appState.selectedSymbol, '60');
                        }
                        // For desktop, treat all mobile pages as Terminal Tabs
                        if (pageId === 'tradesPage' || pageId === 'historyPage') {
                            app.ui.showTerminalTab(pageId === 'tradesPage' ? 'trades' : 'history');
                        }
                    }

                    // Update dynamic content on page load
                    if (pageId === 'depositCoinSelectionPage') app.logic.loadDepositCoins();
                    if (pageId === 'accountDashboardPage') app.ui.renderAccountDashboard();
                    if (pageId === 'quotesPage') app.logic.updateQuotesPage();
                    if (pageId === 'historyPage') app.ui.renderActivityHistory();
                }
            },
            // Toast Notification
            showMessage: (message, type = 'info') => {
                const colors = {
                    info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500'
                };
                const toast = document.createElement('div');
                toast.className = `fixed top-20 right-4 p-3 rounded-lg shadow-lg text-sm z-[100] ${colors[type] || colors.info}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            },
            // Generic Modal
            showModal: (title, message) => {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('genericModal').classList.remove('hidden');
            },
            hideModal: () => {
                document.getElementById('genericModal').classList.add('hidden');
            },
            // Loading Screen (Simulated 15s wait)
            showLoading: (text = 'Processing request...') => {
                let loadingModal = document.getElementById('loadingModal');
                if (!loadingModal) {
                    loadingModal = document.createElement('div');
                    loadingModal.id = 'loadingModal';
                    loadingModal.className = 'fixed inset-0 bg-black bg-opacity-80 z-[110] flex flex-col items-center justify-center';
                    loadingModal.innerHTML = `
                        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-yellow-400"></div>
                        <p id="loadingText" class="mt-4 text-white text-lg">${text}</p>
                    `;
                    document.body.appendChild(loadingModal);
                } else {
                    document.getElementById('loadingText').textContent = text;
                    loadingModal.classList.remove('hidden');
                }
            },
            hideLoading: () => {
                document.getElementById('loadingModal')?.classList.add('hidden');
            },
            toggleDropdown: (dropdownId) => {
                document.querySelectorAll(`#${dropdownId}`).forEach(el => el.classList.toggle('hidden'));
            },
            hideMenuDropdown: () => {
                 document.getElementById('moreMenuDropdown')?.classList.add('hidden');
            },
            updateFooterActive: (pageId) => {
                document.querySelectorAll('.footer-btn').forEach(btn => {
                    const isActive = btn.getAttribute('data-page') === pageId;
                    btn.classList.toggle('text-yellow-400', isActive);
                    btn.classList.toggle('text-gray-400', !isActive);
                });
            },
            showOrderTicket: () => {
                document.getElementById('orderTicketModal').classList.remove('hidden');
                app.logic.renderOrderSymbolSelect();
            },
            hideOrderTicket: () => {
                document.getElementById('orderTicketModal').classList.add('hidden');
            },
            renderAccountDashboard: () => {
                document.getElementById('accountIdDisplay').textContent = appState.currentAccountId;
                document.getElementById('desktopAccountId').textContent = appState.currentAccountId;
                document.getElementById('totalTradeBalance').textContent = `$${(appState.balances.totalUSD + appState.balances.equityUSD).toFixed(2)}`;
                document.getElementById('withdrawCurrentBalance').textContent = `$${appState.balances.tradeUSD.toFixed(2)}`;
                
                // Update Profile
                document.getElementById('profileAccountId').textContent = appState.currentAccountId;
                document.getElementById('profileWalletAddress').textContent = appState.currentWalletAddress;
                document.getElementById('profileWalletBalance').textContent = `$${appState.balances.tradeUSD.toFixed(2)}`;
                document.getElementById('secureAccountBtnText').textContent = appState.is2FAEnabled ? '2FA Enabled (Manage)' : 'Secure Account (2FA Setup)';

                app.ui.renderTokenHoldings();
            },
            renderTokenHoldings: () => {
                const container = document.getElementById('tokenHoldingsList');
                if (!container) return;
                
                // Mock holdings if none exist
                if (appState.tokenHoldings.length === 0) {
                    appState.tokenHoldings = [
                        { symbol: 'BTC', amount: 0.005, usdValue: 350.00, price: 70000.00 },
                        { symbol: 'ETH', amount: 0.1, usdValue: 300.00, price: 3000.00 },
                    ];
                    utils.saveState();
                }

                container.innerHTML = appState.tokenHoldings.map(h => `
                    <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-semibold">${h.symbol}</span>
                            <p class="text-xs text-gray-400">$${h.price.toFixed(2)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">${h.amount.toFixed(4)}</p>
                            <p class="text-sm text-gray-400">$${h.usdValue.toFixed(2)}</p>
                        </div>
                    </div>
                `).join('');
            },
            renderActivityHistory: () => {
                const container = document.getElementById('activityHistoryList');
                const terminalContainer = document.getElementById('terminalHistoryList');
                if (!container || !terminalContainer) return;

                if (appState.activities.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No history yet.</p>';
                    terminalContainer.innerHTML = '<p class="text-gray-500 text-sm">No recent activity.</p>';
                    return;
                }

                const renderItem = (activity) => {
                    const date = new Date(activity.date).toLocaleString();
                    let statusClass = 'text-green-400';
                    if (activity.status === 'Processing') statusClass = 'text-yellow-400';
                    if (activity.status === 'Failed') statusClass = 'text-red-400';
                    
                    let countdown = '';
                    if (activity.type === 'Withdrawal' && activity.status === 'Processing') {
                        const remaining = app.logic.getCountdownTime(activity.endTime);
                        if (remaining) {
                            countdown = `<span class="ml-2 text-sm text-yellow-400">(${remaining} remaining)</span>`;
                        }
                    }

                    return `
                        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-sm">${activity.type}</span>
                                <span class="${statusClass} text-sm">${activity.status}</span>
                            </div>
                            <p class="text-xs text-gray-400">${activity.desc} ${countdown}</p>
                            <p class="text-xs text-gray-500 mt-1">${date}</p>
                        </div>
                    `;
                };

                container.innerHTML = appState.activities.map(renderItem).join('');
                terminalContainer.innerHTML = appState.activities.slice(0, 10).map(renderItem).join(''); // Show latest 10 in terminal
            },
            renderOpenPositions: () => {
                const container = document.getElementById('openPositionsList');
                const terminalContainer = document.getElementById('terminalPositionsList');
                if (!container || !terminalContainer) return;

                if (appState.activeTrades.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No active trades.</p>';
                    terminalContainer.innerHTML = '<p class="text-gray-500 text-sm">No active positions.</p>';
                    return;
                }
                
                const renderTrade = (trade) => {
                    const pnlClass = trade.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    const durationRemaining = app.logic.getCountdownTime(trade.expectedEndTime);
                    
                    return `
                        <div class="bg-gray-700 p-3 rounded-lg border border-gray-600">
                            <div class="flex justify-between items-center">
                                <span class="font-bold">${trade.symbol} <span class="${trade.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-xs ml-1">${trade.type} ${trade.volume}</span></span>
                                <span class="font-bold ${pnlClass}">$${trade.pnl.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>Open: ${new Date(trade.openTime).toLocaleTimeString()}</span>
                                <span>Close In: ${durationRemaining || 'Expired'}</span>
                            </div>
                            <button onclick="app.logic.closePosition('${trade.id}')" class="w-full mt-2 text-center text-red-400 hover:text-red-300 text-xs">Close Position</button>
                        </div>
                    `;
                };

                container.innerHTML = appState.activeTrades.map(renderTrade).join('');
                terminalContainer.innerHTML = appState.activeTrades.map(renderTrade).join('');
            },
            showTerminalTab: (tabName) => {
                document.querySelectorAll('.terminal-panel').forEach(panel => panel.classList.add('hidden'));
                document.getElementById(`terminal-${tabName}`).classList.remove('hidden');

                document.querySelectorAll('.terminal-tab').forEach(tab => {
                    const isActive = tab.getAttribute('data-tab') === tabName;
                    tab.classList.toggle('border-yellow-400', isActive);
                    tab.classList.toggle('text-yellow-400', isActive);
                    tab.classList.toggle('border-transparent', !isActive);
                    tab.classList.toggle('hover:border-gray-500', !isActive);
                    tab.classList.toggle('text-gray-300', !isActive);
                });
            }
        };

        // --- 3.5. API & DATA FETCHING ---
        const api = {
            fetchCoinList: async (vs_currency = 'usd', per_page = 200) => {
                try {
                    const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=${vs_currency}&order=market_cap_desc&per_page=${per_page}&page=1&sparkline=false`);
                    if (!response.ok) throw new Error('Failed to fetch coin list');
                    return await response.json();
                } catch (error) {
                    console.error("CoinGecko fetch failed:", error);
                    app.ui.showMessage('Market data failed to load.', 'error');
                    return [];
                }
            },
            fetchCoinPrice: async (coinId) => {
                try {
                    const response = await fetch(`${COINGECKO_API}/simple/price?ids=${coinId}&vs_currencies=usd`);
                    if (!response.ok) throw new Error('Failed to fetch price');
                    const data = await response.json();
                    return data[coinId]?.usd || 0.00;
                } catch (error) {
                    console.error("CoinGecko price fetch failed:", error);
                    return 0.00;
                }
            },
            getStatusUpdates: async () => {
                 // Using a mocked endpoint to respect the user's instruction while providing content
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/status_updates');
                    if (!response.ok) throw new Error('Failed to fetch status updates');
                    return await response.json();
                } catch (error) {
                    // Fallback mock data
                    return { status_updates: [{ description: 'Global markets open strong with Bitcoin consolidating above the 70k level. Altcoins show signs of upward momentum after a brief correction. Be mindful of upcoming CPI data releases.', created_at: new Date().toISOString() }] };
                }
            }
        };

        // --- 3.6. CORE LOGIC ---
        let allCoins = [];
        let selectedDepositCoin = null;

        const logic = {
            init: () => {
                utils.loadState();
                
                // Set up persistent event listeners
                document.getElementById('moreMenuBtn').addEventListener('click', () => {
                    app.ui.toggleDropdown('moreMenuDropdown');
                });
                
                // Start persistent timers
                logic.startPersistentTimers();
                
                // Check authentication status and route
                if (appState.isAuthenticated) {
                    logic.initialTradeSetup();
                    app.ui.showPage('quotesPage'); // Default trade page
                } else {
                    app.ui.showPage('landingPage');
                }
                
                // Initial update of mobile/desktop quotes
                logic.fetchQuotes();

                // Set initial notification toggle state
                document.getElementById('notificationToggle').checked = appState.notificationSettings.enabled;
            },

            // --- ACCOUNT & AUTH LOGIC ---
            createRealAccount: async () => {
                const address = document.getElementById('createWalletAddress').value.trim();
                const network = document.getElementById('selectedNetworkText').textContent;
                const password = document.getElementById('createPassword').value;

                if (!address || network === 'Select Network' || !password) {
                    return app.ui.showMessage('Please fill in all account creation details.', 'error');
                }

                app.ui.showLoading('Connecting wallet, fetching balance, and generating Account ID...');
                await utils.waitFor(15000); // 15-second loading simulation

                // Web3 Simulation
                // const web3 = new Web3(new Web3.providers.HttpProvider(`https://${network.toLowerCase()}.infura.io/v3/${INFURA_ID}`));
                // Mock Balance Fetch
                const balance = parseFloat((Math.random() * 1000 + 100).toFixed(2)); // $100 - $1100 simulated deposit

                appState.currentAccountId = utils.generateAccountId();
                appState.currentWalletAddress = address;
                appState.currentNetwork = network;
                appState.passwordHash = utils.hashPassword(password);
                appState.balances.totalUSD = balance;
                appState.balances.tradeUSD = balance;
                appState.isAuthenticated = true;

                // Save new account to list
                appState.savedAccounts.push({
                    accountId: appState.currentAccountId,
                    address: appState.currentWalletAddress,
                    network: appState.currentNetwork,
                    passwordHash: appState.passwordHash
                });

                utils.saveState();
                logic.initialTradeSetup();
                app.ui.hideLoading();
                app.ui.showModal('Account Created!', `Your unique Account ID is ${appState.currentAccountId}. Please save it.`);
                app.ui.showPage('quotesPage');
            },
            loginToAccount: async () => {
                const address = document.getElementById('loginWalletAddress').value.trim();
                const network = document.getElementById('loginSelectedNetworkText').textContent;
                const password = document.getElementById('loginPassword').value;

                if (!address || network === 'Select Network' || !password) {
                    return app.ui.showMessage('Please fill in all login details.', 'error');
                }

                const hash = utils.hashPassword(password);
                const account = appState.savedAccounts.find(
                    a => a.address.toLowerCase() === address.toLowerCase() &&
                         a.network === network &&
                         a.passwordHash === hash
                );

                app.ui.showLoading('Verifying credentials and logging in...');
                await utils.waitFor(5000); // 5-second login load
                
                if (account) {
                    appState.currentAccountId = account.accountId;
                    appState.currentWalletAddress = account.address;
                    appState.currentNetwork = account.network;
                    appState.passwordHash = account.passwordHash; // Already set but kept for clarity
                    appState.isAuthenticated = true;
                    utils.saveState();
                    logic.initialTradeSetup();
                    app.ui.hideLoading();
                    app.ui.showMessage(`Welcome back, Account ${appState.currentAccountId}`, 'success');
                    app.ui.showPage('quotesPage');
                } else {
                    app.ui.hideLoading();
                    app.ui.showMessage('Incorrect credentials. Please check address, network, and password.', 'error');
                }
            },
            loadSavedAccounts: () => {
                const container = document.getElementById('savedAccountsDropdown');
                if (appState.savedAccounts.length === 0) {
                    container.innerHTML = '<p class="p-3 text-center text-gray-500">No saved accounts found.</p>';
                    container.classList.remove('hidden');
                    return;
                }
                
                container.innerHTML = appState.savedAccounts.map(acc => `
                    <button onclick="app.logic.prefillLogin('${acc.accountId}')" class="w-full text-left p-3 hover:bg-gray-700 rounded-lg">
                        <span class="font-semibold text-yellow-400">ID: ${acc.accountId}</span><br>
                        <span class="text-xs text-gray-400 break-all">${acc.address} on ${acc.network}</span>
                    </button>
                `).join('');
                container.classList.remove('hidden');
            },
            prefillLogin: (accountId) => {
                const account = appState.savedAccounts.find(a => a.accountId === accountId);
                if (account) {
                    document.getElementById('loginWalletAddress').value = account.address;
                    app.logic.selectNetwork(account.network, 'login');
                    // Note: Password cannot be pre-filled due to security.
                    app.ui.showMessage(`Account ${accountId} details loaded. Please enter your password.`, 'info');
                }
            },
            logout: () => {
                appState.isAuthenticated = false;
                appState.currentAccountId = null;
                appState.currentWalletAddress = null;
                appState.currentNetwork = null;
                utils.saveState();
                app.ui.showMessage('Successfully logged out.', 'success');
                app.ui.showPage('landingPage');
            },
            selectNetwork: (network, page = 'create') => {
                const networkText = document.getElementById(page === 'create' ? 'selectedNetworkText' : 'loginSelectedNetworkText');
                const dropdownId = page === 'create' ? 'networkDropdown' : 'loginNetworkDropdown';
                networkText.textContent = network;
                app.ui.toggleDropdown(dropdownId);
            },

            // --- TRADING & MARKET LOGIC ---
            initialTradeSetup: () => {
                if (!appState.activeTrades.length) {
                    // Set a default symbol if none is selected
                    appState.selectedSymbol = appState.selectedSymbol || 'BTC/USD';
                    utils.saveState();
                }
                document.getElementById('selectedSymbolDisplay').textContent = appState.selectedSymbol;
                
                // Initialize TV widget on chart page
                app.logic.createTV(appState.selectedSymbol, '60');
            },
            createTV: (symbol = 'BTC/USD', interval = '60') => {
                const container = 'tv_chart_container';
                document.getElementById(container).innerHTML = ''; // Clear existing chart
                
                new TradingView.widget({
                    "container_id": container,
                    "width": "100%",
                    "height": "100%",
                    "symbol": `BINANCE:${symbol.replace('/', '')}`, // Use a common pair format for TV
                    "interval": interval,
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#0b1220",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "hide_top_toolbar": false,
                    "withdateranges": true,
                    "studies": ["MACD@tv-basicstudies", "RSI@tv-basicstudies"],
                    "details": true,
                    "hotlist": false,
                    "calendar": true
                });
                
                document.getElementById('chartTitle').innerText = `TradingView Chart  ${symbol} / ${interval}`;
            },
            updateChartInterval: (interval) => {
                app.logic.createTV(appState.selectedSymbol, interval);
            },
            updateChartSymbol: (symbol) => {
                appState.selectedSymbol = symbol;
                utils.saveState();
                document.getElementById('selectedSymbolDisplay').textContent = symbol;
                app.logic.createTV(symbol, '60'); // Reset to 1h interval
            },
            fetchQuotes: async () => {
                let coins = await api.fetchCoinList('usd', 20);
                
                // Mock Forex/Commodity data to make it look like a real broker
                const mockAssets = [
                    { symbol: 'EUR/USD', name: 'Euro/US Dollar', price_usd: 1.0950 + (Math.random() * 0.01 - 0.005) },
                    { symbol: 'GBP/JPY', name: 'Great British Pound/Japanese Yen', price_usd: 185.00 + (Math.random() * 0.5 - 0.25) },
                    { symbol: 'XAU/USD', name: 'Gold/US Dollar', price_usd: 2350.00 + (Math.random() * 5 - 2.5) },
                ];
                
                const tradeableAssets = coins.map(c => ({
                    symbol: `${c.symbol.toUpperCase()}/USD`,
                    name: c.name,
                    price_usd: c.current_price,
                    image: c.image
                })).slice(0, 15).concat(mockAssets); // Get top 15 crypto + mocks

                appState.tradeableAssets = tradeableAssets;
                utils.saveState();
                app.logic.updateQuotesPage();
            },
            updateQuotesPage: () => {
                const containerMobile = document.getElementById('quotesList');
                const containerDesktop = document.getElementById('desktopQuotesList');
                if (!appState.tradeableAssets || appState.tradeableAssets.length === 0) {
                    containerMobile.innerHTML = '<p class="text-gray-500 text-center py-4">No assets available.</p>';
                    containerDesktop.innerHTML = '<p class="text-gray-500 text-center py-4">No assets available.</p>';
                    return;
                }
                
                const renderQuote = (asset) => {
                    const price = asset.price_usd.toFixed(4);
                    const isCrypto = asset.image;
                    const logo = isCrypto ? `<img src="${asset.image}" class="w-6 h-6 rounded-full mr-2" onerror="this.onerror=null;this.src='https://placehold.co/24x24/1f2937/ffffff?text=${asset.symbol.substring(0,2)}'" />` : `<span class="w-6 h-6 mr-2 flex items-center justify-center bg-gray-600 rounded-full">${asset.symbol.substring(0,1)}</span>`;

                    return `
                        <div onclick="app.logic.showQuoteMenu('${asset.symbol}')" class="flex items-center justify-between p-3 bg-gray-800 rounded-lg border-b border-gray-700 hover:bg-gray-700 cursor-pointer">
                            <div class="flex items-center">
                                ${logo}
                                <div>
                                    <p class="font-semibold">${asset.symbol}</p>
                                    <p class="text-xs text-gray-400">${asset.name}</p>
                                </div>
                            </div>
                            <span class="font-bold text-lg text-green-400">${price}</span>
                        </div>
                    `;
                };

                containerMobile.innerHTML = appState.tradeableAssets.map(renderQuote).join('');
                containerDesktop.innerHTML = appState.tradeableAssets.map(asset => `
                    <div onclick="app.logic.updateChartSymbol('${asset.symbol}')" class="text-sm p-2 rounded-lg hover:bg-gray-700 cursor-pointer">
                        ${asset.symbol}: <span class="font-mono text-green-400 float-right">${asset.price_usd.toFixed(4)}</span>
                    </div>
                `).join('');
            },
            showQuoteMenu: (symbol) => {
                app.ui.showModal('Asset Options', `
                    <p class="mb-4">Selected Asset: <span class="font-bold text-yellow-400">${symbol}</span></p>
                    <button onclick="app.logic.updateChartSymbol('${symbol}'); app.ui.showPage('chartsPage'); app.ui.hideModal();" class="btn-secondary w-full mb-2">View Chart</button>
                    <button onclick="app.ui.showOrderTicket(); app.logic.updateOrderTicketSymbol('${symbol}'); app.ui.hideModal();" class="btn-primary w-full mb-2">New Order</button>
                    <button onclick="app.ui.showMessage('Market Statistics mocked for ${symbol}', 'info'); app.ui.hideModal();" class="btn-secondary w-full">Market Statistics</button>
                `);
            },
            updateOrderTicketSymbol: (symbol) => {
                document.getElementById('orderSymbol').value = symbol;
            },
            renderOrderSymbolSelect: () => {
                const select = document.getElementById('orderSymbol');
                select.innerHTML = appState.tradeableAssets.map(a => `<option value="${a.symbol}">${a.symbol}</option>`).join('');
                select.value = appState.selectedSymbol;
            },
            
            // --- TRADE SIMULATION ---
            placeTrade: (type) => {
                const symbol = document.getElementById('orderSymbol').value;
                const volume = parseFloat(document.getElementById('orderVolume').value);
                const durationMonths = parseInt(document.getElementById('tradeDuration').value);
                const sl = parseFloat(document.getElementById('orderStopLoss').value) || null;
                const tp = parseFloat(document.getElementById('orderTakeProfit').value) || null;

                if (appState.balances.tradeUSD < 10) { // Require minimum margin
                    return app.ui.showMessage('Insufficient trade balance (min $10 required).', 'error');
                }
                
                const margin = volume * 1000; // Mock margin calculation
                const asset = appState.tradeableAssets.find(a => a.symbol === symbol);
                const currentPrice = asset?.price_usd || 1.0;

                const newTrade = {
                    id: crypto.randomUUID(),
                    symbol,
                    type,
                    volume,
                    openPrice: currentPrice,
                    openTime: Date.now(),
                    durationMonths,
                    expectedEndTime: Date.now() + durationMonths * 30 * 24 * 60 * 60 * 1000,
                    margin,
                    pnl: 0,
                    initialMargin: margin,
                };
                
                appState.balances.tradeUSD -= margin;
                appState.activeTrades.push(newTrade);
                
                appState.activities.unshift({
                    type: 'Trade',
                    desc: `${type} ${volume} lot(s) of ${symbol}. Margin: $${margin.toFixed(2)}`,
                    date: new Date().toISOString(),
                    status: 'Active'
                });
                
                app.ui.hideOrderTicket();
                app.ui.showMessage(`Trade ${type} ${symbol} activated!`, 'success');
                app.ui.showPage('tradesPage');
                utils.saveState();
            },
            closePosition: (tradeId) => {
                const index = appState.activeTrades.findIndex(t => t.id === tradeId);
                if (index === -1) return;

                const trade = appState.activeTrades.splice(index, 1)[0];
                
                // Return initial margin and add PNL to equity
                appState.balances.tradeUSD += trade.initialMargin;
                appState.balances.equityUSD += trade.pnl;
                
                appState.activities.unshift({
                    type: 'Trade Close',
                    desc: `Closed ${trade.type} ${trade.volume} lot(s) of ${trade.symbol}. P/L: $${trade.pnl.toFixed(2)}`,
                    date: new Date().toISOString(),
                    status: 'Closed'
                });
                
                app.ui.showMessage(`Position closed! P/L: $${trade.pnl.toFixed(2)}`, trade.pnl >= 0 ? 'success' : 'error');
                utils.saveState();
            },
            tradeSimulationLoop: () => {
                // Runs every minute
                const now = Date.now();
                const ratePerMinute = DAILY_RETURN_RATE / (24 * 60); // 7.95% daily / 1440 minutes

                appState.activeTrades.forEach(trade => {
                    const timeElapsedMs = now - trade.openTime;
                    const minutesElapsed = Math.floor(timeElapsedMs / (60 * 1000));
                    
                    // Simple cumulative PNL simulation
                    // PNL increases based on margin * rate * minutes
                    const newPnl = trade.initialMargin * ratePerMinute * minutesElapsed;
                    trade.pnl = newPnl;

                    // Check if trade duration has ended
                    if (now >= trade.expectedEndTime) {
                        logic.finalizeTrade(trade.id);
                    }
                });

                // Update Balances & UI
                app.ui.renderAccountDashboard();
                app.ui.renderOpenPositions();
                app.ui.renderActivityHistory();
            },
            finalizeTrade: (tradeId) => {
                const index = appState.activeTrades.findIndex(t => t.id === tradeId);
                if (index === -1) return;

                const trade = appState.activeTrades.splice(index, 1)[0];
                
                // Add Initial Margin + PNL to Total Trade Balance
                const totalReturn = trade.initialMargin + trade.pnl;
                appState.balances.totalUSD += totalReturn;
                appState.balances.tradeUSD += totalReturn; // Add to tradeable balance as well

                appState.activities.unshift({
                    type: 'Trade Finalized',
                    desc: `${trade.type} ${trade.symbol} trade ended. Total Return: $${totalReturn.toFixed(2)}. P/L: $${trade.pnl.toFixed(2)}`,
                    date: new Date().toISOString(),
                    status: 'Closed & Settled'
                });

                app.ui.showMessage(`Trade ${trade.symbol} settled! Profit: $${trade.pnl.toFixed(2)} added to balance.`, 'success');
                utils.saveState();
            },

            // --- DEPOSIT LOGIC (FROM PROMPT SNIPPET) ---
            loadDepositCoins: async () => {
                const depositCoinList = document.getElementById('depositCoinList');
                if (!depositCoinList) return;

                depositCoinList.innerHTML = '<p class="text-center text-gray-400 py-4">Loading coins...</p>';

                try {
                    if (allCoins.length === 0) {
                        allCoins = await api.fetchCoinList('usd', 200);
                    }

                    allCoins.sort((a, b) => a.symbol.localeCompare(b.symbol)); // Sort AZ
                    logic.renderDepositCoinList(allCoins);
                } catch (error) {
                    console.error("Error loading deposit coins:", error);
                    depositCoinList.innerHTML = '<p class="text-center text-red-500 py-4">Failed to load coins. Please try again later.</p>';
                }

                const searchInput = document.getElementById('depositSearch');
                if (searchInput) {
                    searchInput.oninput = (e) => {
                        const searchTerm = e.target.value.trim().toLowerCase();
                        if (!searchTerm) return logic.renderDepositCoinList(allCoins);

                        const filtered = allCoins.filter(
                            c => c.name.toLowerCase().includes(searchTerm) || c.symbol.toLowerCase().includes(searchTerm)
                        );
                        logic.renderDepositCoinList(filtered);
                    };
                }
            },
            renderDepositCoinList: (coins) => {
                const container = document.getElementById('depositCoinList');
                if (!container) return;

                if (!coins || coins.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-400 py-4">No matching coins found.</p>';
                    return;
                }

                let html = '';
                coins.forEach(coin => {
                    // Only show coins that have defined networks for deposit
                    const symbol = coin.symbol.toUpperCase();
                    if (!DEPOSIT_NETWORKS[symbol]) return;

                    html += `
                        <div class="deposit-coin-item flex items-center justify-between p-3 bg-gray-900 rounded-lg border border-gray-800 hover:bg-gray-800 cursor-pointer" 
                            data-symbol="${symbol}"
                            data-name="${coin.name}"
                            data-id="${coin.id}"
                            data-image="${coin.image}">
                            <div class="flex items-center gap-3">
                                <img src="${coin.image}" class="w-8 h-8 rounded-full"
                                    onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${symbol.substring(0,2).toUpperCase()}'" />
                                <div>
                                    <p class="font-semibold">${symbol}</p>
                                    <p class="text-xs text-gray-400">${coin.name}</p>
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    `;
                });
                container.innerHTML = html;

                document.querySelectorAll('.deposit-coin-item').forEach(item => {
                    item.onclick = () => {
                        logic.selectDepositCoin(item.dataset.symbol, item.dataset.image);
                    };
                });
            },
            selectDepositCoin: (symbol, image) => {
                selectedDepositCoin = { symbol, image };
                document.getElementById('depositCoinName').textContent = symbol;
                document.getElementById('depositAddressCoinSymbol').textContent = symbol;
                logic.renderNetworkSelection(symbol);
                app.ui.showPage('depositNetworkPage');
            },
            renderNetworkSelection: (coinSymbol) => {
                const container = document.getElementById('networkSelectionList');
                if (!container) return;
                
                const networks = DEPOSIT_NETWORKS[coinSymbol] || ['Ethereum'];
                container.innerHTML = networks.map(network => `
                    <button class="network-select-btn w-full flex items-center py-4 px-5 bg-gray-900 border border-gray-700 rounded-xl hover:bg-gray-800 transition"
                        data-network="${network}">
                        <span class="text-md font-semibold">${network}</span>
                        <svg class="w-5 h-5 ml-auto text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                `).join('');

                document.querySelectorAll('.network-select-btn').forEach(btn => {
                    btn.onclick = () => {
                        const network = btn.dataset.network;
                        logic.openDepositAddressPage(selectedDepositCoin.symbol, network);
                    };
                });
            },
            openDepositAddressPage: (symbol, network) => {
                const address = DEPOSIT_ADDRESSES[network.toUpperCase().replace(/\s*\(.*\)/g, '')];
                if (!address) {
                    return app.ui.showMessage(`No deposit address found for ${symbol} on ${network}.`, 'error');
                }

                appState.currentDeposit = { coin: symbol, network, address };
                app.ui.showPage('depositAddressPage');
                document.getElementById('depositNetworkHeader').textContent = network;
                document.getElementById('depositAddressDisplay').textContent = address;

                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: address, width: 160, height: 160,
                    colorDark: "#000000", // QR Code must be dark on light background for scanning
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            },
            copyDepositAddress: () => {
                const address = document.getElementById('depositAddressDisplay').textContent;
                if (!address) return;
                navigator.clipboard.writeText(address)
                    .then(() => app.ui.showMessage('Address copied to clipboard!', 'success'))
                    .catch(() => app.ui.showMessage('Failed to copy address.', 'error'));
            },
            showDepositConfirmationPage: () => {
                const amount = parseFloat(document.getElementById('depositAmountInput').value);
                if (isNaN(amount) || amount <= 0) {
                    return app.ui.showMessage('Please enter a valid deposit amount.', 'error');
                }

                appState.currentDeposit.amount = amount;
                document.getElementById('depositConfirmAmount').textContent = amount.toFixed(2);
                document.getElementById('depositVerificationCode').value = '';
                document.getElementById('depositCodeError').classList.add('hidden');
                app.ui.showPage('depositConfirmPage');
            },
            handleDepositConfirmation: async () => {
                const code = parseInt(document.getElementById('depositVerificationCode').value);
                const errorMsg = document.getElementById('depositCodeError');
                if (!code || isNaN(code)) {
                    errorMsg.textContent = 'Enter your 6-digit verification code.';
                    errorMsg.classList.remove('hidden');
                    return;
                }

                errorMsg.classList.add('hidden');
                app.ui.showLoading('Processing deposit...');
                await utils.waitFor(15000); // 15s load

                if (!DEPOSIT_CODES.includes(code)) {
                    app.ui.hideLoading();
                    errorMsg.textContent = 'Invalid or used verification code.';
                    errorMsg.classList.remove('hidden');
                    return;
                }

                // Success
                appState.balances.totalUSD += appState.currentDeposit.amount;
                appState.balances.tradeUSD += appState.currentDeposit.amount;

                appState.activities.unshift({
                    type: 'Deposit',
                    desc: `Deposited $${appState.currentDeposit.amount.toFixed(2)} ${appState.currentDeposit.coin} via ${appState.currentDeposit.network}.`,
                    date: new Date().toISOString(),
                    status: 'Success'
                });

                utils.saveState();
                app.ui.hideLoading();
                app.ui.showModal('Deposit Successful', `Successfully deposited $${appState.currentDeposit.amount.toFixed(2)} ${appState.currentDeposit.coin}.`);
                app.ui.showPage('accountDashboardPage');
            },
            
            // --- WITHDRAWAL LOGIC ---
            selectWithdrawNetwork: (network) => {
                document.getElementById('withdrawSelectedNetworkText').textContent = network;
                app.ui.toggleDropdown('withdrawNetworkDropdown');
                appState.currentWithdrawal.network = network;
            },
            fillWithdrawalAddress: () => {
                document.getElementById('withdrawalAddressInput').value = appState.currentWalletAddress || '0x... (No connected wallet address found)';
            },
            setMaxWithdrawal: () => {
                document.getElementById('withdrawalAmountInput').value = appState.balances.tradeUSD.toFixed(2);
            },
            showWithdrawalConfirmation: () => {
                if (appState.withdrawalState.suspensionEndTime > Date.now()) {
                    const remaining = logic.getCountdownTime(appState.withdrawalState.suspensionEndTime);
                    return app.ui.showModal('Withdrawal Suspended', `Your withdrawal function is suspended. Remaining time: ${remaining}.`);
                }

                const address = document.getElementById('withdrawalAddressInput').value.trim();
                const network = document.getElementById('withdrawSelectedNetworkText').textContent;
                const amount = parseFloat(document.getElementById('withdrawalAmountInput').value);

                if (!address || network === 'Select Network' || isNaN(amount) || amount <= 0 || amount > appState.balances.tradeUSD) {
                    return app.ui.showMessage('Invalid details or insufficient balance.', 'error');
                }

                appState.currentWithdrawal = { address, network, amount };
                document.getElementById('withdrawalValidationCode').value = '';
                document.getElementById('withdrawalCodeError').classList.add('hidden');
                app.ui.showPage('withdrawalConfirmPage');
            },
            handleWithdrawalConfirmation: async () => {
                const code = document.getElementById('withdrawalValidationCode').value;
                const errorMsg = document.getElementById('withdrawalCodeError');
                
                if (!code || code.length !== 6) {
                    errorMsg.textContent = 'Enter a valid 6-digit code.';
                    errorMsg.classList.remove('hidden');
                    return;
                }

                app.ui.showLoading('Validating code...');
                await utils.waitFor(5000); 

                if (WITHDRAWAL_VALID_CODES.includes(code)) {
                    // Success: Start 24-hour countdown
                    appState.withdrawalState.inProgress = true;
                    appState.withdrawalState.endTime = Date.now() + 24 * 60 * 60 * 1000; // 24 hours
                    appState.withdrawalState.attempts = 0; // Reset attempts
                    appState.currentWithdrawal.status = 'Processing';

                    appState.activities.unshift({
                        type: 'Withdrawal',
                        desc: `Processing $${appState.currentWithdrawal.amount.toFixed(2)} to ${appState.currentWithdrawal.network}.`,
                        date: new Date().toISOString(),
                        status: 'Processing',
                        endTime: appState.withdrawalState.endTime,
                    });

                    utils.saveState();
                    app.ui.hideLoading();
                    app.ui.showMessage('Withdrawal initiated! Processing will take 24 hours.', 'success');
                    app.ui.showPage('historyPage');

                } else {
                    // Failure: Increment attempts and check for suspension
                    appState.withdrawalState.attempts += 1;
                    
                    if (appState.withdrawalState.attempts >= 5) {
                        appState.withdrawalState.suspensionEndTime = Date.now() + 48 * 60 * 60 * 1000; // 48 hours
                        appState.withdrawalState.attempts = 0;
                        utils.saveState();
                        app.ui.hideLoading();
                        app.ui.showModal('Withdrawal Suspended', '5 failed attempts. Withdrawal function suspended for 48 hours.');
                        
                        appState.activities.unshift({
                            type: 'Security Alert',
                            desc: `Withdrawal function suspended for 48 hours due to failed attempts.`,
                            date: new Date().toISOString(),
                            status: 'Suspended',
                        });
                        app.ui.renderActivityHistory();
                        app.ui.showPage('withdrawalPage');
                    } else {
                        utils.saveState();
                        app.ui.hideLoading();
                        errorMsg.textContent = `Incorrect code. ${5 - appState.withdrawalState.attempts} attempts remaining before suspension.`;
                        errorMsg.classList.remove('hidden');
                    }
                }
            },
            getCountdownTime: (timestamp) => {
                const now = Date.now();
                const diff = timestamp - now;
                if (diff <= 0) return null;

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },
            
            // --- TIMER & PERSISTENCE LOOP ---
            startPersistentTimers: () => {
                // 1. Withdrawal Countdown / Finalization
                setInterval(() => {
                    const now = Date.now();
                    
                    // A) Check for suspension
                    if (appState.withdrawalState.suspensionEndTime > now) {
                        const remaining = logic.getCountdownTime(appState.withdrawalState.suspensionEndTime);
                        document.getElementById('withdrawalSuspensionMessage').textContent = `Suspended: ${remaining}`;
                        document.getElementById('withdrawalSuspensionMessage').classList.remove('hidden');
                        document.getElementById('withdrawalPage').querySelector('.btn-primary').disabled = true;
                    } else {
                        document.getElementById('withdrawalSuspensionMessage').classList.add('hidden');
                        document.getElementById('withdrawalPage').querySelector('.btn-primary').disabled = false;
                        appState.withdrawalState.suspensionEndTime = null;
                    }

                    // B) Check for withdrawal completion
                    if (appState.withdrawalState.inProgress && appState.withdrawalState.endTime <= now) {
                        // Withdrawal successful!
                        appState.balances.totalUSD -= appState.currentWithdrawal.amount;
                        appState.balances.tradeUSD -= appState.currentWithdrawal.amount;
                        appState.withdrawalState.inProgress = false;
                        appState.currentWithdrawal.status = 'Success';

                        const activityIndex = appState.activities.findIndex(a => a.type === 'Withdrawal' && a.status === 'Processing');
                        if (activityIndex !== -1) {
                            appState.activities[activityIndex].status = 'Success';
                            appState.activities[activityIndex].desc = `Withdrawal of $${appState.currentWithdrawal.amount.toFixed(2)} completed to ${appState.currentWithdrawal.network}.`;
                        }

                        utils.saveState();
                        app.ui.showMessage(`Withdrawal Successful: $${appState.currentWithdrawal.amount.toFixed(2)} deducted from balance.`, 'success');
                        app.ui.renderAccountDashboard();
                        app.ui.renderActivityHistory();
                    } else if (appState.withdrawalState.inProgress && appState.withdrawalState.endTime > now) {
                        // Still counting down
                        app.ui.renderActivityHistory(); // Update countdown display
                    }

                    // 2. Trade Simulation
                    logic.tradeSimulationLoop();
                    
                    // 3. Update Quotes (every 1 minute)
                    logic.fetchQuotes();

                    // 4. Update UI
                    app.ui.renderAccountDashboard();
                    
                }, 60000); // Runs every 60 seconds (1 minute)

                // Mobile More Menu Listener
                document.getElementById('moreMenuBtn').onclick = () => app.ui.toggleDropdown('moreMenuDropdown');
            },

            // --- NOTIFICATION LOGIC ---
            toggleNotifications: (enabled) => {
                appState.notificationSettings.enabled = enabled;
                utils.saveState();
                app.ui.showMessage(`Daily notifications turned ${enabled ? 'ON' : 'OFF'}.`, 'info');
            },
            showDailyNotification: async () => {
                if (!appState.notificationSettings.enabled) return;
                
                const now = Date.now();
                const lastDismissed = appState.notificationSettings.dismissedNotificationTimestamp || 0;
                
                // Check if 12 hours have passed since last dismissal
                if (now - lastDismissed < 12 * 60 * 60 * 1000) return;

                const updates = await api.getStatusUpdates();
                const latest = updates.status_updates?.[0];
                
                if (latest) {
                    document.getElementById('notificationMessage').textContent = `[Daily Update] ${latest.description.substring(0, 100)}...`;
                    document.getElementById('notificationBanner').classList.remove('hidden');
                }
            },
            dismissNotification: () => {
                document.getElementById('notificationBanner').classList.add('hidden');
                appState.notificationSettings.dismissedNotificationTimestamp = Date.now();
                utils.saveState();
            },
            loadCoinNews: async () => {
                const container = document.getElementById('newsFeed');
                container.innerHTML = '<p class="text-center text-gray-400 py-4">Fetching live news...</p>';
                const updates = await api.getStatusUpdates();
                
                if (updates.status_updates && updates.status_updates.length > 0) {
                    container.innerHTML = updates.status_updates.slice(0, 10).map(update => `
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="font-semibold text-yellow-400">${update.description}</p>
                            <p class="text-xs text-gray-400 mt-1">${new Date(update.created_at || Date.now()).toLocaleString()}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-center text-gray-500 py-4">No recent market news available.</p>';
                }
            },
            
            // --- 2FA LOGIC ---
            setup2FA: () => {
                if (appState.is2FAEnabled) {
                    document.getElementById('authSetupPanel').classList.add('hidden');
                    document.getElementById('authLinkedPanel').classList.remove('hidden');
                    return;
                }

                // Generate and display QR code
                const secret = utils.generate2FASecret();
                appState.twoFASecret = secret;
                
                document.getElementById('authAccountId').textContent = appState.currentAccountId;
                document.getElementById('authSecretKey').textContent = secret;
                
                const issuer = 'MT5 Trader';
                const label = `${issuer}:${appState.currentAccountId}`;
                const otpauth = otplib.authenticator.keyuri(label, issuer, secret);

                const qrContainer = document.getElementById('qrcode2FA');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: otpauth,
                    width: 128, height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                document.getElementById('authSetupPanel').classList.remove('hidden');
                document.getElementById('authLinkedPanel').classList.add('hidden');
            },
            verify2FA: async () => {
                const code = document.getElementById('authVerificationCode').value.trim();
                
                if (!code || code.length !== 6) return app.ui.showMessage('Please enter the 6-digit code.', 'error');
                
                app.ui.showLoading('Verifying 2FA Code...');
                await utils.waitFor(5000); // 5s load

                if (utils.validate2FA(appState.twoFASecret, code)) {
                    appState.is2FAEnabled = true;
                    utils.saveState();
                    app.ui.hideLoading();
                    app.ui.showMessage('Google Authenticator linked successfully!', 'success');
                    logic.setup2FA(); // Re-render to show linked panel
                } else {
                    app.ui.hideLoading();
                    app.ui.showMessage('Invalid 2FA code. Try again.', 'error');
                }
            },
            disable2FA: () => {
                appState.is2FAEnabled = false;
                appState.twoFASecret = null;
                utils.saveState();
                app.ui.showMessage('2FA disabled.', 'info');
                logic.setup2FA(); // Re-render to show setup panel
            }
        };

        // --- 3.7. INITIALIZATION ---
        
        // Global App Object
        const app = {
            state: appState,
            logic: logic,
            ui: ui,
            utils: utils,
            api: api,
        };

        // Initialize the application on load
        window.addEventListener('load', () => {
            // Check for TradingView widget script loading and then init the core logic
            const checkTV = setInterval(() => {
                if (typeof TradingView !== 'undefined' && typeof otplib !== 'undefined' && typeof CryptoJS !== 'undefined' && typeof QRCode !== 'undefined') {
                    clearInterval(checkTV);
                    app.logic.init();
                    
                    // Start periodic notification check (Hourly)
                    setInterval(app.logic.showDailyNotification, 3600000); 
                    // Initial check
                    app.logic.showDailyNotification();
                }
            }, 100);
            
             // Re-render 2FA setup if page is loaded
            if (document.getElementById('googleAuthPage').classList.contains('active')) {
                app.logic.setup2FA();
            }
        });

    </script>
</body>
</html>
