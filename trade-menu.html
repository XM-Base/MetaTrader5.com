<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT5 Trader - Trading Platform</title>
    <link rel="icon" href="https://placehold.co/32x32/1e40af/ffffff?text=MT5">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Dark Theme & Font */
        :root {
            --mt5-bg-dark: #12121e;
            --mt5-header-bg: #1c1c27;
            --mt5-toolbar-bg: #0b1220;
            --mt5-green: #37d399; /* Buy/Profit color */
            --mt5-red: #f44336;   /* Sell/Loss color */
            --mt5-accent: #ffeb3b; /* Yellow accent */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--mt5-bg-dark);
            color: #f0f0f0;
            overscroll-behavior: none;
        }
        /* Page container structure */
        .page-container {
            min-height: calc(100vh - 80px - 56px); /* 100vh - header - footer */
            padding-bottom: 20px;
        }
        /* MT5-style scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1c1c27;
        }
        ::-webkit-scrollbar-thumb {
            background: #44475a;
            border-radius: 4px;
        }
        .mt5-header {
            background-color: var(--mt5-header-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .mt5-footer {
            background-color: var(--mt5-header-bg);
            border-top: 1px solid #2d2d3c;
        }
        .mt5-input, .mt5-select {
            background-color: #0b1220;
            border: 1px solid #2d2d3c;
            color: #f0f0f0;
        }
        .btn-primary {
            background-color: #1e40af;
            color: white;
            transition: background-color 0.1s;
        }
        .btn-primary:hover {
            background-color: #1e3a8a;
        }
        .btn-buy {
            background-color: var(--mt5-green);
            color: var(--mt5-bg-dark);
        }
        .btn-sell {
            background-color: var(--mt5-red);
            color: white;
        }
        .trading-data-card {
            background-color: #1c1c27;
            border: 1px solid #2d2d3c;
        }
        .mobile-nav-icon {
            flex-grow: 1;
        }
        /* Ensure TradingView container fills space */
        #tv_chart_container {
            width: 100%;
            height: calc(100vh - 80px - 56px - 40px); /* 100vh - header - footer - chart header */
            min-height: 400px;
        }
        .loader {
            border-top-color: var(--mt5-accent);
        }
    </style>

    <!-- Required Scripts -->
    <!-- otplib for TOTP -->
    <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.min.js"></script>
    <!-- Crypto-JS for encryption/hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Web3 & WalletConnect -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <!-- TradingView Widget -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    <!-- QRCode Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Phosphor Icons (for SVG icons) -->
    <script src="https://unpkg.com/phosphor-icons"></script>
</head>
<body class="overflow-y-scroll">

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p id="loadingMessage" class="text-white text-lg font-semibold">Loading...</p>
        </div>
    </div>

    <!-- Global Notification Banner -->
    <div id="notificationBanner" class="fixed top-0 left-0 right-0 z-40 p-3 bg-yellow-600 text-white text-center font-medium transition-all duration-300 transform -translate-y-full flex items-center justify-between">
        <span id="bannerMessage"></span>
        <button onclick="hideBanner()" class="ml-4 text-white hover:text-gray-200">
            <i class="ph-x-bold"></i>
        </button>
    </div>

    <!-- Global App Container -->
    <div id="app">

        <!-- MT5 Style Header (Persistent) -->
        <header id="mt5Header" class="sticky top-0 z-30 mt5-header h-14 flex items-center justify-between px-3 md:px-6">
            <button id="backButton" onclick="goBack()" class="flex items-center text-gray-400 hover:text-white mr-4 hidden">
                <i class="ph-arrow-left-bold text-xl"></i>
            </button>
            <h1 class="text-xl font-bold text-white flex-grow">MT5 Trader</h1>

            <!-- Header Buttons -->
            <div class="flex items-center space-x-3">
                <!-- Selected Symbol (Dynamic) -->
                <div id="selectedSymbolDisplay" class="text-sm font-mono text-mt5-green hidden md:block"></div>

                <!-- Add Symbol -->
                <button onclick="showPage('quotesPage'); loadQuotes()" class="p-2 rounded-full hover:bg-gray-800 transition text-gray-400">
                    <i class="ph-magnifying-glass-plus-bold text-xl"></i>
                </button>

                <!-- More Menu -->
                <div class="relative">
                    <button id="moreMenuBtn" onclick="toggleMenu('moreMenuDropdown')" class="p-2 rounded-full hover:bg-gray-800 transition text-gray-400">
                        <i class="ph-dots-three-bold text-xl"></i>
                    </button>
                    <div id="moreMenuDropdown" class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl z-50 hidden">
                        <a href="javascript:void(0)" onclick="showPage('accountDashboard'); toggleMenu('moreMenuDropdown')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">
                            <i class="ph-wallet-bold mr-2"></i> Account
                        </a>
                        <a href="javascript:void(0)" onclick="showPage('newsPage'); toggleMenu('moreMenuDropdown')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">
                            <i class="ph-newspaper-bold mr-2"></i> News
                        </a>
                        <a href="mailto:mt5-base@hotmail.com" onclick="toggleMenu('moreMenuDropdown')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">
                            <i class="ph-envelope-bold mr-2"></i> Mailbox
                        </a>
                        <a href="javascript:void(0)" onclick="showPage('settingsPage'); toggleMenu('moreMenuDropdown')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">
                            <i class="ph-gear-bold mr-2"></i> Settings
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="h-full">

            <!-- 1. XM Landing Page -->
            <div id="landingPage" class="page-container p-6 flex flex-col items-center justify-center text-center">
                <div class="max-w-md w-full trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-extrabold text-mt5-accent mb-4">MT5 Trader</h2>
                    <p class="text-gray-400 mb-8">Trade Forex, Stocks, and Crypto with institutional-grade conditions. Fast execution and deep liquidity.</p>

                    <button onclick="showPage('accountCreationPage')" class="btn-primary w-full py-3 rounded-xl text-lg font-semibold mb-4">
                        <i class="ph-user-plus-bold mr-2"></i> Create Real Account
                    </button>

                    <button onclick="showPage('loginPage')" class="w-full py-3 rounded-xl text-lg font-semibold text-mt5-accent border border-mt5-accent hover:bg-mt5-accent/10 transition">
                        <i class="ph-sign-in-bold mr-2"></i> Login to Existing Account
                    </button>
                    <p id="savedAccountsList" class="text-sm text-gray-500 mt-4 cursor-pointer hover:text-mt5-accent" onclick="toggleMenu('savedAccountsDropdown')"></p>
                    <div id="savedAccountsDropdown" class="mt-2 text-left bg-gray-700 rounded-lg shadow-lg hidden">
                        <!-- Saved accounts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- 2. Account Creation Page -->
            <div id="accountCreationPage" class="page-container p-6 hidden">
                <div class="max-w-lg mx-auto trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-mt5-accent">Create Real Account</h2>
                    <div class="space-y-4">
                        <input id="createWalletAddress" type="text" placeholder="Enter Wallet Address (or Connect)" class="mt5-input w-full p-3 rounded-lg">
                        <div class="relative">
                            <button id="networkSelectorBtn" onclick="toggleMenu('networkDropdownCreation')" class="mt5-input w-full p-3 rounded-lg text-left flex justify-between items-center">
                                <span id="selectedNetworkCreation">Select Network</span>
                                <i class="ph-caret-down-bold"></i>
                            </button>
                            <div id="networkDropdownCreation" class="absolute w-full mt-1 bg-gray-800 rounded-lg shadow-xl z-10 hidden">
                                <a href="javascript:void(0)" onclick="selectNetwork('BNB Smart Chain (BEP20)', 'create')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">BNB Smart Chain (BEP20)</a>
                                <a href="javascript:void(0)" onclick="selectNetwork('Ethereum', 'create')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Ethereum</a>
                                <a href="javascript:void(0)" onclick="selectNetwork('Tron (TRC20)', 'create')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Tron (TRC20)</a>
                            </div>
                        </div>
                        <input id="createPassword" type="password" placeholder="Creation Password" class="mt5-input w-full p-3 rounded-lg">
                        <button onclick="connectWalletAndCreateAccount()" class="btn-buy w-full py-3 rounded-xl text-lg font-semibold mt-6">
                            Connect Wallet & Create Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. Login Page -->
            <div id="loginPage" class="page-container p-6 hidden">
                <div class="max-w-lg mx-auto trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-mt5-accent">Login to Account</h2>
                    <div class="space-y-4">
                        <input id="loginWalletAddress" type="text" placeholder="Enter Wallet Address" class="mt5-input w-full p-3 rounded-lg">
                        <div class="relative">
                            <button id="networkSelectorBtnLogin" onclick="toggleMenu('networkDropdownLogin')" class="mt5-input w-full p-3 rounded-lg text-left flex justify-between items-center">
                                <span id="selectedNetworkLogin">Select Network</span>
                                <i class="ph-caret-down-bold"></i>
                            </button>
                            <div id="networkDropdownLogin" class="absolute w-full mt-1 bg-gray-800 rounded-lg shadow-xl z-10 hidden">
                                <a href="javascript:void(0)" onclick="selectNetwork('BNB Smart Chain (BEP20)', 'login')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">BNB Smart Chain (BEP20)</a>
                                <a href="javascript:void(0)" onclick="selectNetwork('Ethereum', 'login')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Ethereum</a>
                                <a href="javascript:void(0)" onclick="selectNetwork('Tron (TRC20)', 'login')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Tron (TRC20)</a>
                            </div>
                        </div>
                        <input id="loginPassword" type="password" placeholder="Account Password" class="mt5-input w-full p-3 rounded-lg">
                        <button onclick="handleLogin()" class="btn-primary w-full py-3 rounded-xl text-lg font-semibold mt-6">
                            Login
                        </button>
                    </div>
                </div>
            </div>

            <!-- 4. Account Dashboard (Home/Trade Menu) -->
            <div id="accountDashboard" class="page-container p-3 md:p-6 hidden">
                <div class="space-y-4">
                    <!-- Header Panel Buttons -->
                    <div class="flex items-center justify-between trading-data-card p-3 rounded-xl shadow-md">
                        <button onclick="showPage('landingPage')" class="p-2 text-sm rounded-lg btn-primary flex items-center">
                            <i class="ph-user-plus-bold mr-1"></i> Add Account
                        </button>
                        <button onclick="showPage('userDetailsPage')" class="p-2 text-sm rounded-lg text-mt5-accent hover:bg-gray-800 flex items-center">
                            <i class="ph-user-circle-bold mr-1 text-xl"></i> Profile
                        </button>
                    </div>

                    <!-- Account Summary -->
                    <div class="trading-data-card p-4 rounded-xl shadow-md space-y-3">
                        <p class="text-xs text-gray-500">Account ID: <span id="dashboardAccountId" class="font-mono text-mt5-accent"></span></p>
                        <div class="flex items-center justify-between border-b border-gray-700 pb-2">
                            <p class="text-gray-400">Account Type</p>
                            <p class="font-bold text-white">Real Account</p>
                        </div>
                        <div class="flex items-center justify-between pt-2">
                            <p class="text-2xl text-gray-400">Total Trade Balance</p>
                            <p class="text-4xl font-extrabold text-white">$<span id="dashboardBalance">0.00</span></p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-around bg-gray-800 p-2 rounded-xl shadow-md">
                        <button onclick="showPage('depositCoinSelectPage'); loadDepositCoins()" class="flex flex-col items-center p-2 text-sm text-white hover:text-mt5-accent">
                            <i class="ph-arrow-square-in-bold text-2xl"></i> Deposit
                        </button>
                        <button onclick="showPage('withdrawPage')" class="flex flex-col items-center p-2 text-sm text-white hover:text-mt5-accent">
                            <i class="ph-arrow-square-out-bold text-2xl"></i> Withdraw
                        </button>
                        <button onclick="showMessage('Transfer feature coming soon.', 'info')" class="flex flex-col items-center p-2 text-sm text-white hover:text-mt5-accent">
                            <i class="ph-arrows-left-right-bold text-2xl"></i> Transfer
                        </button>
                        <button onclick="showPage('orderTicketPage')" class="flex flex-col items-center p-2 text-sm text-white hover:text-mt5-accent">
                            <i class="ph-arrow-fat-up-bold text-2xl"></i> Order
                        </button>
                    </div>

                    <!-- Token Holdings -->
                    <div class="trading-data-card p-4 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold mb-3">Token Holdings</h3>
                        <div id="tokenHoldingsList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4">No tokens added yet.</p>
                        </div>
                    </div>

                    <!-- Transactions & Activity (History Summary) -->
                    <div class="trading-data-card p-4 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold mb-3">Recent Activity</h3>
                        <div id="activitySummaryList" class="space-y-2 text-sm">
                            <!-- Activities will be rendered here -->
                        </div>
                        <button onclick="showPage('historyPage')" class="w-full mt-4 text-center text-mt5-accent hover:underline text-sm">View All History</button>
                    </div>
                </div>
            </div>

            <!-- 5. Quotes Page (Market Watch) -->
            <div id="quotesPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-4xl mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-4">Quotes (Market Watch)</h2>
                    <div id="quotesList" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">Loading market symbols...</p>
                    </div>
                </div>
            </div>

            <!-- 6. Charts Page -->
<div id="chartsPage" class="page-container hidden flex flex-col h-screen">
    <!-- Chart Header -->
    <div class="bg-gray-900 p-2 md:p-3 flex items-center justify-between border-b border-gray-800 shadow-lg z-10">
        <div class="flex items-center space-x-3 md:space-x-4">
            <h2 id="chartTitle" class="text-white text-lg md:text-xl font-bold truncate max-w-xs md:max-w-lg">
                <span class="text-cyan-400">TradingView Chart</span> • 
                <span id="currentChartSymbol" class="text-yellow-400">Loading...</span>
            </h2>
            <div class="hidden md:flex items-center space-x-2">
                <span class="text-green-500 text-sm font-medium">● Live</span>
                <span class="text-gray-400 text-sm">|</span>
                <span id="chartPrice" class="text-white text-sm">--</span>
                <span id="chartChange" class="text-sm font-medium">--</span>
            </div>
        </div>
        
        <div class="flex items-center space-x-2 md:space-x-4">
            <!-- Chart Controls -->
            <div class="hidden md:flex items-center space-x-2 bg-gray-800 rounded-lg p-1">
                <button onclick="changeChartTimeframe('1D')" class="px-3 py-1 text-xs rounded bg-gray-700 text-white hover:bg-gray-600">
                    1D
                </button>
                <button onclick="changeChartTimeframe('1W')" class="px-3 py-1 text-xs rounded hover:bg-gray-700 text-gray-300">
                    1W
                </button>
                <button onclick="changeChartTimeframe('1M')" class="px-3 py-1 text-xs rounded hover:bg-gray-700 text-gray-300">
                    1M
                </button>
                <button onclick="changeChartTimeframe('1Y')" class="px-3 py-1 text-xs rounded hover:bg-gray-700 text-gray-300">
                    1Y
                </button>
            </div>
            
            <!-- Action Buttons -->
            <button onclick="showMessage('Indicators & Strategies coming soon', 'info')" 
                    class="text-gray-300 hover:text-cyan-400 p-2 hover:bg-gray-800 rounded-lg transition-colors">
                <i class="ph-trend-up-bold text-lg"></i>
                <span class="hidden md:inline ml-1 text-sm">Indicators</span>
            </button>
            
            <button onclick="showPage('orderTicketPage', { symbol: appState.currentSymbol })" 
                    class="btn-buy p-2 px-4 rounded-lg text-sm font-bold hover:opacity-90 transition-opacity flex items-center">
                <i class="ph-arrow-up-right-bold mr-1"></i>
                <span>Trade</span>
            </button>
            
            <!-- Fullscreen Toggle -->
            <button onclick="toggleChartFullscreen()" 
                    class="text-gray-400 hover:text-white p-2 hover:bg-gray-800 rounded-lg hidden md:block">
                <i class="ph-arrows-out-simple-bold text-lg"></i>
            </button>
        </div>
    </div>
    
    <!-- Normal Chart Page -->
<div id="chartsPage" class="relative w-full h-full">
    <h2 id="chartTitle" class="text-sm text-gray-300 px-4 py-2"></h2>
    <div id="tv_chart_container" class="w-full h-[calc(100vh-48px)]"></div>
</div>

<!-- Fullscreen Chart Overlay -->
<div id="fullscreenChart"
     class="fixed inset-0 bg-black z-50 hidden flex flex-col">
    
    <div class="flex items-center justify-between px-4 py-2 bg-gray-900">
        <span id="fullscreenChartTitle" class="text-sm text-gray-200"></span>
        <button onclick="toggleChartFullscreen()"
                class="text-gray-300 hover:text-white">
            ✕ Exit Fullscreen
        </button>
    </div>

    <div id="fullscreenChartContainer" class="flex-1"></div>
</div>
    
    <!-- Chart Footer (Optional) -->
    <div class="bg-gray-900 border-t border-gray-800 p-2 hidden md:block">
        <div class="flex items-center justify-between text-xs text-gray-400">
            <div class="flex space-x-4">
                <span>Time: <span id="chartTime" class="text-white">--:--:--</span></span>
                <span>O: <span id="chartOpen" class="text-white">--</span></span>
                <span>H: <span id="chartHigh" class="text-white">--</span></span>
                <span>L: <span id="chartLow" class="text-white">--</span></span>
                <span>C: <span id="chartClose" class="text-white">--</span></span>
            </div>
            <div>
                <span>Volume: <span id="chartVolume" class="text-white">--</span></span>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Chart Modal -->
<div id="fullscreenChart" class="hidden fixed inset-0 bg-black z-50">
    <div class="absolute top-0 left-0 right-0 bg-gray-900 p-3 flex items-center justify-between">
        <h2 id="fullscreenChartTitle" class="text-white text-xl font-bold"></h2>
        <button onclick="toggleChartFullscreen()" class="text-white p-2 hover:bg-gray-800 rounded-lg">
            <i class="ph-x-bold text-xl"></i>
        </button>
    </div>
    <div id="fullscreenChartContainer" class="absolute inset-0 pt-12"></div>
</div>

            <!-- 7. Trades Page (Toolbox/Terminal) -->
            <div id="tradesPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-4xl mx-auto space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4 text-sm font-medium">
                        <div class="trading-data-card p-3 rounded-lg">Balance: $<span id="tradeBalance">0.00</span></div>
                        <div class="trading-data-card p-3 rounded-lg">Equity: $<span id="tradeEquity">0.00</span></div>
                        <div class="trading-data-card p-3 rounded-lg">Margin: $<span id="tradeMargin">0.00</span></div>
                        <div class="trading-data-card p-3 rounded-lg">Free Margin: $<span id="tradeFreeMargin">0.00</span></div>
                        <div class="trading-data-card p-3 rounded-lg">Margin Level: <span id="tradeMarginLevel">0.00%</span></div>
                    </div>

                    <h3 class="text-xl font-bold mb-3">Open Positions</h3>
                    <div id="openPositionsList" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No open trades.</p>
                        <!-- Open trades will be rendered here -->
                    </div>

                    <div id="closePositionControls" class="trading-data-card p-4 rounded-xl shadow-md flex justify-center space-x-4">
                        <button onclick="closeAllPositions()" class="btn-sell p-3 rounded-lg text-sm font-bold">
                            <i class="ph-x-circle-bold mr-1"></i> Close All Positions
                        </button>
                    </div>
                </div>
            </div>

            <!-- 8. History Page -->
            <div id="historyPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-4xl mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-4">Account History & Activity</h2>
                    <div id="withdrawalSuspensionBanner" class="bg-red-900 p-3 rounded-lg text-sm text-white mb-4 hidden">
                        <i class="ph-warning-bold mr-2"></i> Withdrawal Suspended: <span id="suspensionCountdown"></span>
                    </div>
                    <div id="historyList" class="space-y-3 trading-data-card p-4 rounded-xl">
                        <!-- History items will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- 9. Settings Page -->
            <div id="settingsPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto trading-data-card p-6 rounded-xl space-y-4">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-6">Settings</h2>

                    <div class="flex items-center justify-between border-b border-gray-700 py-3">
                        <span>Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="flex items-center justify-between border-b border-gray-700 py-3">
                        <span>Theme (Light/Dark)</span>
                        <label class="switch">
                            <input type="checkbox" id="themeToggle" checked onchange="toggleTheme()">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <button onclick="showPage('authPage')" class="w-full py-3 rounded-lg btn-primary text-sm font-semibold">
                        <i class="ph-lock-key-bold mr-2"></i> Configure 2FA (Google Auth)
                    </button>

                    <button onclick="logout()" class="w-full py-3 rounded-lg btn-sell text-sm font-semibold mt-6">
                        <i class="ph-sign-out-bold mr-2"></i> Logout
                    </button>
                </div>
            </div>

            <!-- 10. Order Ticket Page -->
            <div id="orderTicketPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-mt5-accent">New Order</h2>

                    <div class="space-y-4">
                        <!-- Symbol Selector -->
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-gray-400">Symbol</label>
                            <select id="orderSymbol" class="mt5-select w-2/3 p-3 rounded-lg" onchange="loadTradingViewChart(this.value)">
                                <!-- Symbols loaded from CoinGecko -->
                            </select>
                        </div>

                        <!-- Type Selector -->
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-gray-400">Type</label>
                            <select id="orderType" class="mt5-select w-2/3 p-3 rounded-lg">
                                <option value="Market Execution">Market Execution</option>
                                <option value="Buy Limit">Buy Limit</option>
                                <option value="Sell Limit">Sell Limit</option>
                            </select>
                        </div>

                        <!-- Volume -->
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-gray-400">Volume (0.01-0.5)</label>
                            <input id="orderVolume" type="number" min="0.01" max="0.5" step="0.01" value="0.10" class="mt5-input w-2/3 p-3 rounded-lg">
                        </div>

                        <!-- Trade Duration -->
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-gray-400">Duration</label>
                            <select id="tradeDuration" class="mt5-select w-2/3 p-3 rounded-lg">
                                <option value="1">1 Month</option>
                                <option value="2">2 Months</option>
                                <option value="3">3 Months</option>
                                <option value="4">4 Months</option>
                                <option value="5">5 Months</option>
                                <option value="6">6 Months</option>
                                <option value="7">7 Months</option>
                                <option value="8">8 Months</option>
                                <option value="9">9 Months</option>
                                <option value="10">10 Months</option>
                                <option value="11">11 Months</option>
                                <option value="12">12 Months</option>
                            </select>
                        </div>

                        <!-- Stop Loss -->
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-gray-400">Stop Loss</label>
                            <input id="orderSL" type="number" placeholder="0.00" class="mt5-input w-2/3 p-3 rounded-lg">
                        </div>

                        <!-- Take Profit -->
                        <div class="flex items-center space-x-2">
                            <label class="w-1/3 text-gray-400">Take Profit</label>
                            <input id="orderTP" type="number" placeholder="0.00" class="mt5-input w-2/3 p-3 rounded-lg">
                        </div>

                        <!-- Buy / Sell Buttons -->
                        <div class="flex space-x-4 mt-6">
                            <button onclick="handleTrade('BUY')" class="btn-buy w-1/2 py-3 rounded-xl text-lg font-bold">
                                <i class="ph-arrow-up-bold mr-1"></i> Buy
                            </button>
                            <button onclick="handleTrade('SELL')" class="btn-sell w-1/2 py-3 rounded-xl text-lg font-bold">
                                <i class="ph-arrow-down-bold mr-1"></i> Sell
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 11. Deposit Select Coin Page -->
            <div id="depositCoinSelectPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-4">Deposit: Select Coin</h2>
                    <input id="depositSearch" type="text" placeholder="Search coin..." class="mt5-input w-full p-3 rounded-lg mb-4">
                    <div id="depositCoinList" class="space-y-2">
                        <!-- Coins loaded from CoinGecko -->
                    </div>
                </div>
            </div>

            <!-- 12. Deposit Select Network Page -->
            <div id="depositNetworkPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-2">Select Network for <span id="depositCoinName" class="text-mt5-green"></span></h2>
                    <p class="text-gray-400 mb-6">Ensure the network matches your withdrawal platform.</p>
                    <div id="networkSelectionList" class="space-y-3">
                        <!-- Networks rendered here -->
                    </div>
                </div>
            </div>

            <!-- 13. Deposit Address & QR Page -->
            <div id="depositAddressPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-6 trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-2">Deposit via <span id="depositNetworkHeader" class="text-mt5-green"></span></h2>

                    <div class="flex justify-center my-4">
                        <div id="qrcode" class="bg-white p-4 rounded-lg"></div>
                    </div>

                    <div class="border border-gray-700 p-3 rounded-lg break-all">
                        <p class="text-xs text-gray-500 mb-1">Deposit Address:</p>
                        <p id="depositAddressDisplay" class="font-mono text-sm text-white"></p>
                    </div>

                    <button onclick="copyDepositAddress()" class="btn-primary w-full py-2 rounded-lg text-sm font-semibold">
                        <i class="ph-copy-bold mr-2"></i> Copy Address
                    </button>

                    <input id="depositAmountInput" type="number" placeholder="Enter Deposit Amount (USD)" min="1" class="mt5-input w-full p-3 rounded-lg">

                    <button onclick="showDepositConfirmationPage()" class="btn-buy w-full py-3 rounded-xl text-lg font-semibold mt-4">
                        Proceed to Confirmation
                    </button>
                </div>
            </div>

            <!-- 14. Deposit Confirmation Page -->
            <div id="depositConfirmPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-6 trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-mt5-accent">Confirm Deposit</h2>
                    <p class="text-lg text-white">Amount: $<span id="depositConfirmAmount">0.00</span></p>

                    <input id="depositVerificationCode" type="number" placeholder="Enter 6-digit Verification Code" class="mt5-input w-full p-3 rounded-lg text-center text-xl tracking-widest">
                    <p id="depositCodeError" class="text-red-500 text-sm hidden">Error message</p>

                    <button onclick="handleDepositConfirmation()" class="btn-buy w-full py-3 rounded-xl text-lg font-semibold mt-4">
                        Submit Deposit
                    </button>
                </div>
            </div>

            <!-- 15. Withdrawal Page -->
            <div id="withdrawPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-6 trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-mt5-accent">Withdraw Funds</h2>

                    <!-- Withdrawal Status/Suspension -->
                    <div id="withdrawalStatus" class="p-3 rounded-lg text-sm font-medium">
                        <!-- Status will be rendered here -->
                    </div>

                    <input id="withdrawAddress" type="text" placeholder="Withdrawal Address" class="mt5-input w-full p-3 rounded-lg">
                    <button onclick="fillAddressFromConnectedWallet()" class="w-full py-2 text-sm text-mt5-accent hover:underline text-left">
                        <i class="ph-wallet-bold mr-2"></i> Or Fill from connected wallet
                    </button>

                    <div class="relative">
                        <button id="withdrawNetworkSelectorBtn" onclick="toggleMenu('withdrawNetworkDropdown')" class="mt5-input w-full p-3 rounded-lg text-left flex justify-between items-center">
                            <span id="selectedWithdrawNetwork">Select Network</span>
                            <i class="ph-caret-down-bold"></i>
                        </button>
                        <div id="withdrawNetworkDropdown" class="absolute w-full mt-1 bg-gray-800 rounded-lg shadow-xl z-10 hidden">
                            <a href="javascript:void(0)" onclick="selectWithdrawNetwork('Ethereum')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Ethereum</a>
                            <a href="javascript:void(0)" onclick="selectWithdrawNetwork('Bitcoin')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Bitcoin</a>
                            <a href="javascript:void(0)" onclick="selectWithdrawNetwork('BSC')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">BSC</a>
                            <a href="javascript:void(0)" onclick="selectWithdrawNetwork('Tron')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Tron</a>
                        </div>
                    </div>

                    <div class="relative flex items-center">
                        <input id="withdrawAmount" type="number" placeholder="Enter Amount" min="0.01" class="mt5-input w-full p-3 rounded-lg pr-16">
                        <button onclick="setMaxWithdrawAmount()" class="absolute right-0 mr-1 p-2 text-mt5-accent text-sm font-bold hover:bg-gray-700 rounded-lg">MAX</button>
                    </div>

                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Gas Fee:</span>
                        <span class="font-bold text-white">0.114 BNB</span>
                    </div>

                    <button onclick="showWithdrawConfirmationPage()" class="btn-sell w-full py-3 rounded-xl text-lg font-semibold mt-4" id="withdrawButton">
                        Withdraw
                    </button>
                </div>
            </div>

            <!-- 16. Withdrawal Confirmation Page -->
            <div id="withdrawConfirmPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-6 trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-mt5-accent">Confirm Withdrawal</h2>

                    <div class="text-sm space-y-2">
                        <p>Address: <span id="withdrawConfirmAddress" class="font-mono text-gray-300 break-all"></span></p>
                        <p>Network: <span id="withdrawConfirmNetwork" class="text-mt5-green"></span></p>
                        <p>Amount: $<span id="withdrawConfirmAmount" class="text-white font-bold"></span></p>
                    </div>

                    <input id="withdrawVerificationCode" type="number" placeholder="Enter 6-digit Validation Code" class="mt5-input w-full p-3 rounded-lg text-center text-xl tracking-widest">
                    <p id="withdrawCodeError" class="text-red-500 text-sm hidden">Error message</p>

                    <button onclick="handleWithdrawConfirmation()" class="btn-sell w-full py-3 rounded-xl text-lg font-semibold mt-4">
                        Submit Withdrawal
                    </button>
                </div>
            </div>

            <!-- 17. Withdrawal Processing Page (View Details) -->
            <div id="withdrawalProcessingPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-6 trading-data-card p-6 rounded-xl shadow-lg text-center">
                    <i class="ph-timer-bold text-6xl text-mt5-accent"></i>
                    <h2 class="text-2xl font-bold text-mt5-accent">Withdrawal Processing</h2>

                    <div class="text-left text-sm space-y-2 border-b border-gray-700 pb-4">
                        <p>Status: <span class="text-yellow-500">Processing (24h Countdown)</span></p>
                        <p>Address: <span id="processingAddress" class="font-mono text-gray-300 break-all"></span></p>
                        <p>Network: <span id="processingNetwork" class="text-mt5-green"></span></p>
                        <p>Amount: $<span id="processingAmount" class="text-white font-bold"></span></p>
                    </div>

                    <div class="text-xl font-mono mt-4">
                        Time Remaining: <span id="countdownDisplay" class="text-mt5-accent font-extrabold"></span>
                    </div>

                    <button onclick="showPage('accountDashboard')" class="w-full py-3 rounded-lg btn-primary text-sm font-semibold">
                        <i class="ph-list-bold mr-2"></i> View Withdrawal Details
                    </button>
                </div>
            </div>

            <!-- 18. Google Auth (2FA) Page -->
            <div id="authPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-6 trading-data-card p-6 rounded-xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold text-mt5-accent">Google Authenticator (2FA)</h2>
                    <p class="text-gray-400">Account ID: <span class="font-mono text-mt5-green" id="authAccountIdDisplay"></span></p>

                    <div id="authQrCode" class="flex justify-center my-4 bg-white p-4 rounded-lg">
                        <!-- QR Code will be generated here -->
                    </div>

                    <div class="border border-gray-700 p-3 rounded-lg break-all">
                        <p class="text-xs text-gray-500 mb-1">Secret Key:</p>
                        <p id="authSecretKey" class="font-mono text-sm text-white cursor-pointer" onclick="copySecretKey()"></p>
                    </div>

                    <input id="authVerificationCode" type="number" placeholder="Enter 6-digit Code from App" class="mt5-input w-full p-3 rounded-lg text-center text-xl tracking-widest">
                    <p id="authCodeError" class="text-red-500 text-sm hidden">Error message</p>

                    <button onclick="verifyAuthCode()" class="btn-primary w-full py-3 rounded-xl text-lg font-semibold mt-4">
                        Verify & Link Account
                    </button>
                </div>
            </div>

            <!-- 19. User Details Page -->
            <div id="userDetailsPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-lg mx-auto space-y-4 trading-data-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-6">User Profile Details</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Account ID:</span>
                            <span id="profileAccountId" class="font-mono text-mt5-green"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Connected Address:</span>
                            <span id="profileWalletAddress" class="font-mono text-white break-all text-xs"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Connected Network:</span>
                            <span id="profileNetwork" class="text-white"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Trade Balance:</span>
                            <span id="profileBalance" class="text-white font-bold">$0.00</span>
                        </div>
                    </div>
                    <button onclick="showPage('authPage')" class="w-full py-3 rounded-lg btn-primary text-sm font-semibold mt-4">
                        <i class="ph-lock-key-bold mr-2"></i> Secure Account (2FA)
                    </button>
                </div>
            </div>

            <!-- 20. News/Notifications Page -->
            <div id="newsPage" class="page-container p-3 md:p-6 hidden">
                <div class="max-w-4xl mx-auto space-y-4">
                    <h2 class="text-2xl font-bold text-mt5-accent mb-4">Market News & Updates</h2>
                    <div id="newsList" class="space-y-4">
                        <p class="text-gray-500 text-center py-4">Loading financial news from CoinGecko...</p>
                    </div>
                </div>
            </div>

        </main>

        <!-- MT5 Style Footer (Persistent) -->
        <footer id="mt5Footer" class="mt5-footer fixed bottom-0 left-0 right-0 h-14 z-30 flex items-center justify-around md:hidden">
            <button onclick="showPage('quotesPage'); loadQuotes()" class="mobile-nav-icon flex flex-col items-center text-xs text-gray-400 hover:text-white transition p-1">
                <i class="ph-list-bold text-xl"></i> Quotes
            </button>
            <button onclick="showPage('chartsPage'); loadTradingViewChart(appState.currentSymbol)" class="mobile-nav-icon flex flex-col items-center text-xs text-gray-400 hover:text-white transition p-1">
                <i class="ph-chart-line-bold text-xl"></i> Charts
            </button>
            <button onclick="showPage('tradesPage'); updateTradesView()" class="mobile-nav-icon flex flex-col items-center text-xs text-gray-400 hover:text-white transition p-1">
                <i class="ph-currency-circle-dollar-bold text-xl"></i> Trades
            </button>
            <button onclick="showPage('historyPage')" class="mobile-nav-icon flex flex-col items-center text-xs text-gray-400 hover:text-white transition p-1">
                <i class="ph-book-open-bold text-xl"></i> History
            </button>
            <button onclick="window.location.href='mailto:mt5-base@hotmail.com'" class="mobile-nav-icon flex flex-col items-center text-xs text-gray-400 hover:text-white transition p-1">
                <i class="ph-envelope-bold text-xl"></i> Mailbox
            </button>
        </footer>

    </div>

    <!-- Global Modal for Messages -->
    <div id="globalModal" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-mt5-accent">Title</h3>
            <p id="modalMessage" class="text-gray-300 mb-4">Message content.</p>
            <button id="modalCloseBtn" onclick="hideModal()" class="btn-primary py-2 px-4 rounded-lg text-sm font-semibold">
                Close
            </button>
            <button id="modalActionBtn" class="btn-buy py-2 px-4 rounded-lg text-sm font-semibold ml-3 hidden"></button>
        </div>
    </div>

<script>
    // =========================================================================
    // 1. GLOBAL CONSTANTS & API KEYS
    // =========================================================================

    const APP_STATE_KEY = 'mt5TraderAppState';
    const COINGECKO_API = 'https://api.coingecko.com/api/v3';

    // Provided Web3/Wallet constants
    const WEB3_API_KEY = "0338f3b98ad211aef5de661cba3f0ead0981460048cfabeee506cdd58a298204";
    const WALLET_CONNECT_PROJECT_ID = "cedd3cec8430b2990ce3fe466ecb1a29";
    const INFURA_ID = "c35d1ef971da479b918c9900134867d4";

    // Provided Withdrawal Codes
    const VALID_WITHDRAW_CODES = [
        "483921", "175064", "902718", "634285", "217509", "856430", "490127", "731694", 
        "562803", "308417", "941256", "128374", "675820", "203519", "487960", "819432", 
        "356701", "740528", "923845", "106753", "549172", "882041", "365910", "794168", 
        "251397", "408623", "673950", "190248", "835764", "512497"
    ];
    let usedWithdrawCodes = new Set();
    let sendAttempts = 0;

    // Provided Deposit Codes
    const DEPOSIT_CODES = [
        482915, 930472, 158203, 764981, 502319, 847261, 319586, 672450, 248391, 905836,
        731258, 629047, 580124, 417902, 896351, 264098, 152983, 309472, 741826, 589320,
        620583, 958210, 203874, 742985, 894621, 510293, 673420, 248765, 901632, 437892
    ];
    let usedDepositCodes = new Set();
    const DEPOSIT_ADDRESSES = {
        'ETHEREUM': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130',
        'TRON': 'TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco',
        'BSC': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130',
        'BITCOIN': 'bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu'
    };
    const DEPOSIT_NETWORKS = {
        USDT: ['Ethereum', 'Tron', 'BSC'],
        BTC: ['Bitcoin'],
        ETH: ['Ethereum'],
        BNB: ['BNB Smart Chain'],
        TRX: ['Tron']
    };
    let allCoins = [];
    let currentDeposit = {};

    // Trading Logic Constants
    const DAILY_RETURN_RATE = 0.0795; // 7.95%
    const SECONDS_IN_DAY = 24 * 60 * 60;
    const RETURN_MULTIPLIER_PER_SECOND = Math.pow(1 + DAILY_RETURN_RATE, 1 / SECONDS_IN_DAY);

    // =========================================================================
    // 2. STATE MANAGEMENT (localStorage)
    // =========================================================================

    let appState = {
        isAuthenticated: false,
        accountId: null,
        walletAddress: null,
        network: null,
        passwordHash: null,
        currentSymbol: 'OANDA:EURUSD',
        balances: {
            totalUSD: 1000.00,
            tradeUSD: 1000.00,
        },
        openTrades: [],
        activities: [],
        savedAccounts: [],
        notifications: {
            enabled: true,
            lastBannerTime: 0,
            dailyNews: [],
        },
        withdraw: {
            isSuspended: false,
            suspensionEndTime: 0,
            countdownEndTime: 0,
            currentWithdrawal: null,
            attemptCount: 0,
        },
        twoFA: {
            enabled: false,
            secret: null,
        },
        tokens: [], // Token Holdings
        history: [], // Full history log
        currentView: 'landingPage',
        theme: 'dark'
    };

    function loadState() {
        try {
            const serializedState = localStorage.getItem(APP_STATE_KEY);
            if (serializedState === null) {
                saveState(); // Initialize if first run
                return;
            }
            const storedState = JSON.parse(serializedState);

            // Merge with defaults to ensure all keys exist
            appState = { ...appState, ...storedState };

            // Special handling for Sets that are saved as Arrays
            if (appState.usedWithdrawCodes) usedWithdrawCodes = new Set(appState.usedWithdrawCodes);
            if (appState.usedDepositCodes) usedDepositCodes = new Set(appState.usedDepositCodes);

            // Navigate to the correct page after refresh
            appState.currentView = appState.isAuthenticated ? 'accountDashboard' : 'landingPage';
        } catch (error) {
            console.error("Error loading state, resetting to initial state:", error);
            localStorage.removeItem(APP_STATE_KEY);
            saveState();
        }
    }

    function saveState() {
        try {
            // Convert Sets back to Arrays for storage
            const stateToSave = { ...appState };
            stateToSave.usedWithdrawCodes = Array.from(usedWithdrawCodes);
            stateToSave.usedDepositCodes = Array.from(usedDepositCodes);

            localStorage.setItem(APP_STATE_KEY, JSON.stringify(stateToSave));
        } catch (error) {
            console.error("Error saving state:", error);
        }
    }

    function generateAccountId() {
        // Generates a 10-digit account ID
        return Math.floor(1000000000 + Math.random() * 9000000000).toString();
    }

    // =========================================================================
    // 3. UI/NAVIGATION UTILITIES
    // =========================================================================

    let historyStack = [];

    function showPage(pageId, params = {}) {
        const pages = document.querySelectorAll('.page-container');
        pages.forEach(page => page.classList.add('hidden'));

        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        } else {
            console.error("Page not found:", pageId);
            return;
        }

        // Handle history stack
        if (pageId !== appState.currentView) {
            historyStack.push(appState.currentView);
        }
        appState.currentView = pageId;

        // Update back button visibility
        const backButton = document.getElementById('backButton');
        if (pageId === 'landingPage' || historyStack.length === 0) {
            backButton.classList.add('hidden');
        } else {
            backButton.classList.remove('hidden');
        }

        // Call specific page loaders
        if (pageId === 'accountDashboard') loadDashboardData();
        if (pageId === 'tradesPage') updateTradesView();
        if (pageId === 'historyPage') renderHistory();
        if (pageId === 'userDetailsPage') renderUserDetails();
        if (pageId === 'authPage') setupGoogleAuthPage();
        if (pageId === 'newsPage') fetchMarketNews();
        if (pageId === 'quotesPage') loadQuotes();
        if (pageId === 'orderTicketPage') setupOrderTicket(params);
        if (pageId === 'chartsPage') loadTradingViewChart(appState.currentSymbol);
        if (pageId === 'withdrawPage') renderWithdrawalStatus();
        if (pageId === 'withdrawalProcessingPage' && appState.withdraw.currentWithdrawal) {
            setupWithdrawalProcessingPage(appState.withdraw.currentWithdrawal);
        }

        saveState();
        window.scrollTo(0, 0); // Scroll to top on page change
    }

    function goBack() {
        if (historyStack.length > 0) {
            const lastPage = historyStack.pop();
            // Prevent pushing the current page to history again
            appState.currentView = lastPage;
            showPage(lastPage);
        } else {
            // Default to dashboard if authenticated, or landing if not
            const defaultPage = appState.isAuthenticated ? 'accountDashboard' : 'landingPage';
            showPage(defaultPage);
        }
        // Special case to fix the back button state when landing page is reached
        if (appState.currentView === 'landingPage') {
            document.getElementById('backButton').classList.add('hidden');
        }
    }

    function toggleMenu(menuId) {
        const menu = document.getElementById(menuId);
        menu.classList.toggle('hidden');
    }

    function showLoading(message = "Processing...") {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showMessage(title, type = 'info', actionButton = null) {
        const modal = document.getElementById('globalModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActionBtn = document.getElementById('modalActionBtn');

        modalTitle.textContent = title;
        modalMessage.textContent = type === 'error' ? `Error: ${title}` : title;
        
        modalTitle.className = 'text-xl font-bold mb-3';
        if (type === 'success') modalTitle.classList.add('text-mt5-green');
        else if (type === 'error') modalTitle.classList.add('text-mt5-red');
        else modalTitle.classList.add('text-mt5-accent');

        modalActionBtn.classList.add('hidden');
        if (actionButton) {
            modalActionBtn.textContent = actionButton.text;
            modalActionBtn.onclick = () => {
                hideModal();
                actionButton.handler();
            };
            modalActionBtn.classList.remove('hidden');
            modalActionBtn.className = 'btn-buy py-2 px-4 rounded-lg text-sm font-semibold ml-3';
        }

        modal.classList.remove('hidden');
    }

    function hideModal() {
        document.getElementById('globalModal').classList.add('hidden');
    }

    function waitFor(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function formatTime(milliseconds) {
        if (milliseconds <= 0) return "00:00:00";
        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const pad = (num) => num.toString().padStart(2, '0');
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    // =========================================================================
    // 4. AUTHENTICATION & ACCOUNT LOGIC
    // =========================================================================

    function checkAuth() {
        if (appState.isAuthenticated) {
            document.getElementById('mt5Header').classList.remove('hidden');
            document.getElementById('mt5Footer').classList.remove('hidden');
            // Update persistent header symbol
            document.getElementById('selectedSymbolDisplay').textContent = appState.currentSymbol;
            document.getElementById('selectedSymbolDisplay').classList.remove('hidden');
            showPage(appState.currentView || 'accountDashboard');
        } else {
            document.getElementById('mt5Header').classList.add('hidden');
            document.getElementById('mt5Footer').classList.add('hidden');
            showPage('landingPage');
        }
        renderSavedAccounts();
    }

    // A simple XOR-based password encryption for localStorage
    function encrypt(text, key = 'mt5trader') {
        return CryptoJS.AES.encrypt(text, key).toString();
    }
    function decrypt(ciphertext, key = 'mt5trader') {
        try {
            const bytes = CryptoJS.AES.decrypt(ciphertext, key);
            return bytes.toString(CryptoJS.enc.Utf8);
        } catch (e) {
            return '';
        }
    }

    function selectNetwork(network, page) {
        if (page === 'create') {
            document.getElementById('selectedNetworkCreation').textContent = network;
            appState.network = network;
            toggleMenu('networkDropdownCreation');
        } else if (page === 'login') {
            document.getElementById('selectedNetworkLogin').textContent = network;
            appState.network = network;
            toggleMenu('networkDropdownLogin');
        }
    }

    async function connectWalletAndCreateAccount() {
        const address = document.getElementById('createWalletAddress').value.trim();
        const network = document.getElementById('selectedNetworkCreation').textContent;
        const password = document.getElementById('createPassword').value;

        if (!address || network === 'Select Network' || !password) {
            showMessage("Please fill in all account creation details.", 'error');
            return;
        }

        showLoading("Connecting Wallet & Creating Account...");
        await waitFor(15000); // 15-second loading

        try {
            // Simulate WalletConnect connection
            const walletProvider = new WalletConnectProvider.default({
                infuraId: INFURA_ID,
                qrcodeModalOptions: {
                    mobileLinks: ["metamask", "trust"]
                }
            });
            await walletProvider.enable();
            const web3 = new Web3(walletProvider);
            const accounts = await web3.eth.getAccounts();
            const connectedAddress = accounts[0];

            // Only use the user-entered address if connection failed or is mocked
            const finalAddress = connectedAddress || address;

            // Fetch wallet balance (Simulated/Mocked due to environment restrictions)
            // A real implementation would use web3.eth.getBalance(finalAddress)
            const mockBalance = parseFloat((Math.random() * 10000 + 500).toFixed(2));

            // Generate 10-digit Account ID
            const newAccountId = generateAccountId();
            const encryptedPassword = encrypt(password);

            // Update State
            appState.accountId = newAccountId;
            appState.walletAddress = finalAddress;
            appState.network = network;
            appState.passwordHash = encryptedPassword;
            appState.balances.totalUSD = mockBalance;
            appState.balances.tradeUSD = mockBalance;
            appState.isAuthenticated = true;

            // Save the new account for the login dropdown
            appState.savedAccounts.push({
                accountId: newAccountId,
                address: finalAddress,
                network: network,
                passwordHash: encryptedPassword,
            });

            appState.activities.unshift({
                type: 'Account Creation',
                desc: `New Real Account created: ID ${newAccountId}. Initial Balance: $${mockBalance.toFixed(2)}`,
                date: new Date().toISOString(),
                status: 'Success'
            });

            saveState();

            hideLoading();
            showMessage(`Account Created!`, `Your Account ID is: ${newAccountId}`, {
                text: "Save Account",
                handler: () => {
                    // Already saved to appState.savedAccounts
                    showMessage("Account Saved", "Your account is saved for quick login.", {
                        text: "Continue to Trade",
                        handler: () => checkAuth()
                    });
                }
            });

        } catch (e) {
            console.error("Wallet connection/creation error:", e);
            hideLoading();
            showMessage(`Failed to connect wallet or create account.`, `Please check your wallet setup. Using entered address: ${address}`, 'error');

            // Fallback: Proceed with mock if connection fails but details are provided
            const newAccountId = generateAccountId();
            const mockBalance = parseFloat((Math.random() * 10000 + 500).toFixed(2));
            const encryptedPassword = encrypt(password);

            appState.accountId = newAccountId;
            appState.walletAddress = address;
            appState.network = network;
            appState.passwordHash = encryptedPassword;
            appState.balances.totalUSD = mockBalance;
            appState.balances.tradeUSD = mockBalance;
            appState.isAuthenticated = true;
             appState.savedAccounts.push({ accountId: newAccountId, address: address, network: network, passwordHash: encryptedPassword });
            appState.activities.unshift({ type: 'Account Creation (Mock)', desc: `New Real Account created: ID ${newAccountId}. Initial Balance: $${mockBalance.toFixed(2)}`, date: new Date().toISOString(), status: 'Success' });
            saveState();
            checkAuth(); // Redirect to trade menu
        }
    }

    async function handleLogin() {
        const address = document.getElementById('loginWalletAddress').value.trim();
        const network = document.getElementById('selectedNetworkLogin').textContent;
        const password = document.getElementById('loginPassword').value;

        if (!address || network === 'Select Network' || !password) {
            showMessage("Please fill in all login details.", 'error');
            return;
        }

        showLoading("Logging In...");
        await waitFor(15000); // 15-second loading

        const account = appState.savedAccounts.find(acc =>
            acc.address.toLowerCase() === address.toLowerCase() &&
            acc.network === network &&
            decrypt(acc.passwordHash) === password
        );

        hideLoading();

        if (account) {
            // Restore session state
            appState.accountId = account.accountId;
            appState.walletAddress = account.address;
            appState.network = account.network;
            appState.passwordHash = account.passwordHash;
            appState.isAuthenticated = true;

            // Re-fetch balances (mock)
            appState.balances.totalUSD = appState.balances.totalUSD || 1000.00;
            appState.balances.tradeUSD = appState.balances.tradeUSD || 1000.00;

            saveState();
            showMessage("Login Successful", `Welcome back, Account ID ${account.accountId}.`, {
                text: "Go to Dashboard",
                handler: () => checkAuth()
            });
        } else {
            showMessage("Incorrect credentials.", "Please verify your Wallet Address, Network, and Password.", 'error');
        }
    }

    function renderSavedAccounts() {
        const container = document.getElementById('savedAccountsDropdown');
        const countDisplay = document.getElementById('savedAccountsList');
        const accounts = appState.savedAccounts;

        countDisplay.textContent = accounts.length > 0 ? `Show ${accounts.length} Saved Accounts` : '';
        if (accounts.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = '';
        accounts.forEach(acc => {
            const item = document.createElement('a');
            item.href = "javascript:void(0)";
            item.className = "block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 truncate";
            item.textContent = `ID: ${acc.accountId} - ${acc.network}`;
            item.onclick = () => {
                document.getElementById('loginWalletAddress').value = acc.address;
                document.getElementById('selectedNetworkLogin').textContent = acc.network;
                appState.network = acc.network;
                toggleMenu('savedAccountsDropdown');
                // Password is intentionally left blank for security, user must enter it.
            };
            container.appendChild(item);
        });
    }

    function logout() {
        appState.isAuthenticated = false;
        appState.currentView = 'landingPage';
        appState.accountId = null;
        // Optionally clear other sensitive/session data
        saveState();
        checkAuth();
        showMessage("Logged Out", "You have been successfully logged out.", { text: "OK" });
    }

    function loadDashboardData() {
        if (!appState.isAuthenticated) return;
        document.getElementById('dashboardAccountId').textContent = appState.accountId;
        document.getElementById('dashboardBalance').textContent = appState.balances.totalUSD.toFixed(2);
        
        // Update header symbol
        document.getElementById('selectedSymbolDisplay').textContent = appState.currentSymbol;

        renderTokenHoldings();
        renderActivitySummary();
        renderWithdrawalSuspensionBanner();
    }

    function renderActivitySummary() {
        const list = document.getElementById('activitySummaryList');
        list.innerHTML = '';
        const recent = appState.activities.slice(0, 5); // Show top 5
        if (recent.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activities.</p>';
            return;
        }

        recent.forEach(activity => {
            const date = new Date(activity.date).toLocaleString();
            let color = activity.status === 'Success' ? 'text-mt5-green' : 'text-mt5-red';
            if (activity.type === 'Trade') color = 'text-mt5-accent';
            
            list.innerHTML += `
                <div class="border-b border-gray-700 py-2">
                    <p class="font-semibold ${color}">${activity.type} - ${activity.status}</p>
                    <p class="text-xs text-gray-500">${date}</p>
                    <p class="text-xs text-gray-400 truncate">${activity.desc}</p>
                </div>
            `;
        });
    }

    // =========================================================================
    // 5. TRADING LOGIC
    // =========================================================================

    async function fetchAllSymbols() {
        try {
            const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_asc&per_page=200&page=1&sparkline=false`);
            if (!response.ok) throw new Error('Failed to fetch market data.');
            const data = await response.json();
            
            // Filter to symbols with names that might be used on TradingView
            const tradingSymbols = data.map(coin => ({
                id: coin.id,
                symbol: coin.symbol.toUpperCase(),
                name: coin.name,
                price: coin.current_price,
                image: coin.image
            })).sort((a, b) => a.symbol.localeCompare(b.symbol));

            // Add standard Forex/Stock symbols for MT5 feel
            const standardSymbols = [
                { id: 'eurusd', symbol: 'EURUSD', name: 'Euro / US Dollar', price: 1.07, image: 'https://placehold.co/32x32/1e40af/ffffff?text=FX' },
                { id: 'gbpusd', symbol: 'GBPUSD', name: 'Pound / US Dollar', price: 1.25, image: 'https://placehold.co/32x32/1e40af/ffffff?text=FX' },
                { id: 'usdjpy', symbol: 'USDJPY', name: 'US Dollar / Yen', price: 157.00, image: 'https://placehold.co/32x32/1e40af/ffffff?text=FX' },
                { id: 'sp500', symbol: 'SPX500', name: 'S&P 500 Index', price: 5200.00, image: 'https://placehold.co/32x32/4b5563/ffffff?text=IDX' },
            ];

            return [...standardSymbols, ...tradingSymbols];

        } catch (error) {
            console.error("Error fetching symbols:", error);
            // Fallback mock data
            return [
                { id: 'bitcoin', symbol: 'BTCUSD', name: 'Bitcoin', price: 68000.00, image: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579' },
                { id: 'ethereum', symbol: 'ETHUSD', name: 'Ethereum', price: 3400.00, image: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png?1590479709' },
                { id: 'eurusd', symbol: 'EURUSD', name: 'Euro / US Dollar', price: 1.07, image: 'https://placehold.co/32x32/1e40af/ffffff?text=FX' },
            ];
        }
    }

    async function loadQuotes() {
        showLoading("Loading quotes...");
        const symbols = await fetchAllSymbols();
        hideLoading();

        const quotesList = document.getElementById('quotesList');
        quotesList.innerHTML = '';

        symbols.forEach(asset => {
            // Using a mock price change for visual effect
            const bid = (asset.price * (1 - Math.random() * 0.005)).toFixed(2);
            const ask = (asset.price * (1 + Math.random() * 0.005)).toFixed(2);
            const spread = (ask - bid).toFixed(2);
            const color = Math.random() > 0.5 ? 'text-mt5-green' : 'text-mt5-red';

            quotesList.innerHTML += `
                <div class="trading-data-card p-4 rounded-xl flex items-center justify-between shadow-md cursor-pointer hover:bg-gray-700"
                    onclick="openAssetMenu('${asset.symbol}', '${asset.name}', '${bid}')">
                    
                    <div class="flex items-center space-x-3">
                        <img src="${asset.image}" onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${asset.symbol.substring(0,2).toUpperCase()}'" class="w-8 h-8 rounded-full" />
                        <div>
                            <p class="font-bold text-white">${asset.symbol}</p>
                            <p class="text-xs text-gray-500">${asset.name}</p>
                        </div>
                    </div>

                    <div class="text-right">
                        <p class="text-xs text-gray-500">Spread: ${spread}</p>
                        <p class="text-lg font-mono font-bold ${color}">Ask: ${ask}</p>
                    </div>
                </div>
            `;
        });
    }

    function openAssetMenu(symbol, name, price) {
        appState.currentSymbol = symbol;
        saveState();
        document.getElementById('selectedSymbolDisplay').textContent = symbol;

        showMessage(
            `${symbol} - ${name}`,
            `Current Price: $${price}`, {
                text: "New Order",
                handler: () => showPage('orderTicketPage', { symbol: symbol })
            },
        );
        document.getElementById('modalActionBtn').insertAdjacentHTML('beforebegin', `
            <button onclick="hideModal(); showPage('chartsPage'); loadTradingViewChart('${symbol}')" class="btn-primary py-2 px-4 rounded-lg text-sm font-semibold mr-3">Chart</button>
            <button onclick="hideModal(); showMessage('Market stats not supported yet.', 'info')" class="btn-primary py-2 px-4 rounded-lg text-sm font-semibold mr-3">Statistics</button>
        `);
    }

    async function setupOrderTicket(params) {
        if (!appState.isAuthenticated) return;
        const symbolSelect = document.getElementById('orderSymbol');
        symbolSelect.innerHTML = '';
        
        // Use current symbol or default
        const currentSymbol = params.symbol || appState.currentSymbol || 'EURUSD';
        
        // Load symbols (cached or fresh)
        const symbols = await fetchAllSymbols();
        
        symbols.forEach(asset => {
            const selected = asset.symbol === currentSymbol ? 'selected' : '';
            symbolSelect.innerHTML += `<option value="${asset.symbol}" ${selected}>${asset.symbol} - ${asset.name}</option>`;
        });

        // Set the selected symbol in state
        appState.currentSymbol = currentSymbol;
        saveState();
    }

    async function handleTrade(type) {
        if (!appState.isAuthenticated) {
            showMessage("Authentication Required", "Please log in to place trades.", 'error');
            return;
        }

        const symbol = document.getElementById('orderSymbol').value;
        const orderType = document.getElementById('orderType').value;
        const volume = parseFloat(document.getElementById('orderVolume').value);
        const durationMonths = parseInt(document.getElementById('tradeDuration').value);
        const sl = parseFloat(document.getElementById('orderSL').value) || 0;
        const tp = parseFloat(document.getElementById('orderTP').value) || 0;

        if (isNaN(volume) || volume < 0.01 || volume > 0.5) {
            showMessage("Invalid Volume", "Volume must be between 0.01 and 0.5.", 'error');
            return;
        }

        const tradeCost = volume * 1000; // Mock cost of $1000 per 1.0 lot, so 0.1 lot = $100
        if (tradeCost > appState.balances.tradeUSD) {
            showMessage("Insufficient Balance", `Trade requires $${tradeCost.toFixed(2)}, but you only have $${appState.balances.tradeUSD.toFixed(2)} available.`, 'error');
            return;
        }

        showLoading("Activating Trade...");
        await waitFor(15000); // 15-second loading

        const now = Date.now();
        const durationMs = durationMonths * 30 * SECONDS_IN_DAY * 1000; // Rough month calculation
        const endTime = now + durationMs;

        const newTrade = {
            id: crypto.randomUUID(),
            symbol,
            type,
            orderType,
            volume,
            cost: tradeCost,
            sl,
            tp,
            startTime: now,
            endTime,
            durationMonths,
            status: 'OPEN',
            initialEquity: tradeCost,
            currentEquity: tradeCost,
            profit: 0,
        };

        appState.openTrades.push(newTrade);
        appState.balances.tradeUSD -= tradeCost; // Deduct balance on activation

        appState.activities.unshift({
            type: 'Trade',
            desc: `${type} ${volume.toFixed(2)} lot(s) of ${symbol} for ${durationMonths} months. Cost: $${tradeCost.toFixed(2)}`,
            date: new Date().toISOString(),
            status: 'OPEN'
        });

        saveState();
        hideLoading();
        showMessage("Trade Activated", `${type} order for ${symbol} activated. Generating returns now.`, {
            text: "View Trades",
            handler: () => showPage('tradesPage')
        });
    }

    function updateTradesView() {
        const list = document.getElementById('openPositionsList');
        const totalEquity = appState.openTrades.reduce((sum, trade) => sum + trade.currentEquity, 0);
        const totalMargin = appState.openTrades.reduce((sum, trade) => sum + trade.cost, 0);

        // Update trade stats
        document.getElementById('tradeBalance').textContent = appState.balances.totalUSD.toFixed(2);
        document.getElementById('tradeEquity').textContent = totalEquity.toFixed(2);
        document.getElementById('tradeMargin').textContent = totalMargin.toFixed(2);
        document.getElementById('tradeFreeMargin').textContent = (appState.balances.tradeUSD + totalEquity - totalMargin).toFixed(2);
        const marginLevel = totalMargin > 0 ? ((appState.balances.tradeUSD + totalEquity) / totalMargin) * 100 : 0;
        document.getElementById('tradeMarginLevel').textContent = `${marginLevel.toFixed(2)}%`;

        list.innerHTML = '';
        if (appState.openTrades.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4">No open trades.</p>';
            return;
        }

        appState.openTrades.forEach(trade => {
            const timeRemaining = trade.endTime - Date.now();
            const timeDisplay = formatTime(timeRemaining);
            const profitColor = trade.profit >= 0 ? 'text-mt5-green' : 'text-mt5-red';

            list.innerHTML += `
                <div class="trading-data-card p-4 rounded-xl shadow-md space-y-2 border-l-4 ${trade.type === 'BUY' ? 'border-mt5-green' : 'border-mt5-red'}">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-lg">${trade.symbol} <span class="text-xs ml-2 py-0.5 px-2 rounded-full ${trade.type === 'BUY' ? 'bg-mt5-green/20 text-mt5-green' : 'bg-mt5-red/20 text-mt5-red'}">${trade.type}</span></p>
                        <p class="font-bold ${profitColor} text-xl">$${trade.profit.toFixed(2)}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-400">
                        <span>Volume: <span class="text-white">${trade.volume.toFixed(2)}</span></span>
                        <span>SL/TP: <span class="text-white">${trade.sl} / ${trade.tp}</span></span>
                        <span>Equity: <span class="text-white">$${trade.currentEquity.toFixed(2)}</span></span>
                        <span>Remaining: <span class="text-mt5-accent">${timeDisplay}</span></span>
                    </div>
                    <div class="pt-2 flex justify-end space-x-2">
                        <button onclick="closeSinglePosition('${trade.id}', false)" class="btn-sell py-1 px-3 rounded text-xs font-bold">
                            Close Position
                        </button>
                        <button onclick="closeSinglePosition('${trade.id}', true)" class="btn-primary py-1 px-3 rounded text-xs font-bold">
                            Stop (24h Pause)
                        </button>
                    </div>
                </div>
            `;
        });
    }

    function calculateTradeReturns() {
        const now = Date.now();
        let newTrades = [];
        let totalProfitGenerated = 0;

        appState.openTrades.forEach(trade => {
            if (trade.status !== 'OPEN') {
                newTrades.push(trade);
                return;
            }

            const multiplier = RETURN_MULTIPLIER_PER_SECOND;
            const elapsedSeconds = (now - trade.startTime) / 1000;

            // Simple profit calculation (compounding daily rate)
            const newEquity = trade.cost * Math.pow(multiplier, elapsedSeconds);
            const newProfit = newEquity - trade.cost;

            trade.currentEquity = newEquity;
            trade.profit = newProfit;
            totalProfitGenerated += newProfit;

            // Check if trade duration has ended
            if (now >= trade.endTime) {
                closeSinglePosition(trade.id, false, true); // True to bypass confirmation
            } else {
                newTrades.push(trade);
            }
        });

        appState.openTrades = newTrades;

        // If on trades page, update the view immediately
        if (appState.currentView === 'tradesPage') {
            updateTradesView();
        }
    }

    function closeAllPositions() {
        if (appState.openTrades.length === 0) {
            showMessage("No Open Positions", "There are no active trades to close.", 'info');
            return;
        }

        showMessage("Confirm Close All", `Are you sure you want to close all ${appState.openTrades.length} open positions?`, {
            text: "Confirm Close",
            handler: () => {
                const now = Date.now();
                appState.openTrades.forEach(trade => {
                    finalizeTradeClosure(trade, now);
                });
                appState.openTrades = [];
                saveState();
                updateTradesView();
                showMessage("All Positions Closed", "All open trades have been closed. Profits/Losses realized.", { text: "OK" });
            }
        });
    }

    function finalizeTradeClosure(trade, now) {
        // Add profit/loss to total balance
        appState.balances.totalUSD += trade.currentEquity;
        appState.balances.tradeUSD += trade.currentEquity - trade.cost; // Add back the original cost + profit/loss

        const finalProfit = trade.currentEquity - trade.cost;

        appState.activities.unshift({
            type: 'Trade Closed',
            desc: `${trade.type} ${trade.symbol} closed. P/L: $${finalProfit.toFixed(2)}. Duration: ${((now - trade.startTime) / (1000 * SECONDS_IN_DAY)).toFixed(2)} days.`,
            date: new Date().toISOString(),
            status: finalProfit >= 0 ? 'Closed (Profit)' : 'Closed (Loss)'
        });
        appState.history.unshift({ ...trade, status: 'CLOSED', closeTime: now, finalProfit });
    }

    function closeSinglePosition(id, isPause, bypassConfirm = false) {
        const tradeIndex = appState.openTrades.findIndex(t => t.id === id);
        if (tradeIndex === -1) return;
        const trade = appState.openTrades[tradeIndex];

        if (isPause) {
            // Logic for 24-hour pause
            trade.status = 'PAUSED';
            trade.resumeTime = Date.now() + 24 * 3600 * 1000;
            saveState();
            updateTradesView();
            showMessage("Trade Paused", `${trade.symbol} trade paused for 24 hours. Resumes at ${new Date(trade.resumeTime).toLocaleTimeString()}.`, { text: "OK" });
            return;
        }

        if (bypassConfirm) {
            finalizeTradeClosure(trade, Date.now());
            appState.openTrades.splice(tradeIndex, 1);
            saveState();
            updateTradesView();
            return;
        }

        showMessage("Confirm Close Position", `Close ${trade.symbol} and realize P/L of $${trade.profit.toFixed(2)}?`, {
            text: "Confirm Close",
            handler: () => {
                finalizeTradeClosure(trade, Date.now());
                appState.openTrades.splice(tradeIndex, 1);
                saveState();
                updateTradesView();
                showMessage("Position Closed", `${trade.symbol} closed. P/L realized: $${trade.profit.toFixed(2)}.`, { text: "OK" });
            }
        });
    }

    // =========================================================================
    // 6. CHARTING (TradingView)
    // =========================================================================

    let tvWidget = null;

    function loadTradingViewChart(symbol = appState.currentSymbol) {
        appState.currentSymbol = symbol;
        saveState();

        const container = 'tv_chart_container';
        const defaultSymbol = 'OANDA:EURUSD';
        const defaultInterval = '60';
        
        // Use a standard symbol if the coin symbol is not suitable for TV
        let tvSymbol = symbol.includes('/') || symbol.includes(':') ? symbol : `BINANCE:${symbol}USDT`; 

        document.getElementById(container).innerHTML = '';
        tvWidget = new TradingView.widget({
            "container_id": container,
            "width": "100%",
            "height": "100%",
            "symbol": tvSymbol,
            "interval": defaultInterval,
            "timezone": "Etc/UTC",
            "theme": appState.theme === 'dark' ? "Dark" : "Light",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#0b1220",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "hide_top_toolbar": false,
            "withdateranges": true,
            "studies": ["MACD@tv-basicstudies", "RSI@tv-basicstudies"],
            "details": true,
            "hotlist": false,
            "calendar": true,
            "autosize": true,
        });
        document.getElementById('chartTitle').innerText = 'TradingView Chart — ' + symbol + ' / 60 Min';
    }
   // Add to your existing JavaScript
function toggleChartFullscreen() {
    const fullscreenChart = document.getElementById('fullscreenChart');
    const chartContainer = document.getElementById('tv_chart_container');
    const fullscreenContainer = document.getElementById('fullscreenChartContainer');
    const chartTitle = document.getElementById('chartTitle').textContent;
    
    if (fullscreenChart.classList.contains('hidden')) {
        // Enter fullscreen
        fullscreenChart.classList.remove('hidden');
        document.getElementById('fullscreenChartTitle').textContent = chartTitle;
        
        // Move or clone chart to fullscreen container
        fullscreenContainer.innerHTML = '';
        fullscreenContainer.appendChild(chartContainer.cloneNode(true));
        
        // Hide original chart page
        document.getElementById('chartsPage').classList.add('hidden');
    } else {
        // Exit fullscreen
        fullscreenChart.classList.add('hidden');
        document.getElementById('chartsPage').classList.remove('hidden');
    }
}

function changeChartTimeframe(timeframe) {
    // This function would update the TradingView chart timeframe
    showMessage(`Timeframe changed to ${timeframe}`, 'info');
    
    // Update active button
    document.querySelectorAll('#chartsPage .bg-gray-700').forEach(btn => {
        btn.classList.remove('bg-gray-700', 'text-white');
        btn.classList.add('hover:bg-gray-700', 'text-gray-300');
    });
    
    event.target.classList.add('bg-gray-700', 'text-white');
    event.target.classList.remove('hover:bg-gray-700', 'text-gray-300');
}

// Initialize chart data display
function updateChartData(symbol, data) {
    document.getElementById('currentChartSymbol').textContent = symbol;
    document.getElementById('chartPrice').textContent = data.price || '--';
    document.getElementById('chartChange').textContent = data.change || '--';
    document.getElementById('chartChange').className = 
        `text-sm font-medium ${data.change && data.change.startsWith('+') ? 'text-green-500' : 'text-red-500'}`;
    
    // Update OHLC data
    if (data.ohlc) {
        document.getElementById('chartOpen').textContent = data.ohlc.open || '--';
        document.getElementById('chartHigh').textContent = data.ohlc.high || '--';
        document.getElementById('chartLow').textContent = data.ohlc.low || '--';
        document.getElementById('chartClose').textContent = data.ohlc.close || '--';
        document.getElementById('chartVolume').textContent = data.ohlc.volume || '--';
    }
    
    // Update time
    document.getElementById('chartTime').textContent = 
        new Date().toLocaleTimeString('en-US', { hour12: false });
            }
    // =========================================================================
    // 7. DEPOSIT SYSTEM
    // =========================================================================

    async function loadDepositCoins() {
        const depositCoinList = document.getElementById('depositCoinList');
        if (!depositCoinList) return;
        depositCoinList.innerHTML = '<p class="text-center text-gray-400 py-4">Loading coins...</p>';

        try {
            if (allCoins.length === 0) {
                const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=false`);
                if (!response.ok) throw new Error('Failed to fetch deposit coins');
                allCoins = await response.json();
            }
            allCoins.sort((a, b) => a.symbol.localeCompare(b.symbol)); // Sort A–Z
            renderDepositCoinList(allCoins);
        } catch (error) {
            console.error("Error loading deposit coins:", error);
            depositCoinList.innerHTML = '<p class="text-center text-red-500 py-4">Failed to load coins. Please try again later.</p>';
        }

        const searchInput = document.getElementById('depositSearch');
        if (searchInput) {
            searchInput.oninput = (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                const filtered = allCoins.filter(
                    c => c.name.toLowerCase().includes(searchTerm) || c.symbol.toLowerCase().includes(searchTerm)
                );
                renderDepositCoinList(filtered);
            };
        }
    }

    function renderDepositCoinList(coins) {
        const container = document.getElementById('depositCoinList');
        if (!container) return;
        if (!coins || coins.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-4">No matching coins found.</p>';
            return;
        }

        let html = '';
        coins.forEach(coin => {
            const symbol = coin.symbol.toUpperCase();
            html += `
                <div class="deposit-coin-item flex items-center justify-between p-3 bg-gray-900 rounded-lg border border-gray-800 hover:bg-gray-800 cursor-pointer"
                    data-symbol="${symbol}" data-name="${coin.name}" data-image="${coin.image}">
                    <div class="flex items-center gap-3">
                        <img src="${coin.image}" class="w-8 h-8 rounded-full"
                            onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${symbol.substring(0,2).toUpperCase()}'" />
                        <div>
                            <p class="font-semibold">${symbol}</p>
                            <p class="text-xs text-gray-400">${coin.name}</p>
                        </div>
                    </div>
                    <i class="ph-caret-right-bold text-lg text-mt5-accent"></i>
                </div>
            `;
        });
        container.innerHTML = html;

        document.querySelectorAll('.deposit-coin-item').forEach(item => {
            item.onclick = () => {
                const symbol = item.dataset.symbol;
                const image = item.dataset.image;
                selectDepositCoin(symbol, image);
            };
        });
    }

    function selectDepositCoin(symbol, image) {
        currentDeposit = { coin: symbol, image };
        document.getElementById('depositCoinName').textContent = symbol;
        renderNetworkSelection(symbol);
        showPage('depositNetworkPage');
    }

    function renderNetworkSelection(coinSymbol) {
        const container = document.getElementById('networkSelectionList');
        if (!container) return;
        
        // Find supported networks, default to Ethereum if not found
        const networks = DEPOSIT_NETWORKS[coinSymbol] || ['Ethereum'];
        
        container.innerHTML = networks.map(network => `
            <button class="network-select-btn w-full flex items-center py-4 px-5 bg-gray-900 border border-gray-700 rounded-xl hover:bg-gray-800 transition"
                data-network="${network}">
                <span class="text-md font-semibold">${network}</span>
                <i class="ph-caret-right-bold text-lg text-mt5-accent ml-auto"></i>
            </button>
        `).join('');

        document.querySelectorAll('.network-select-btn').forEach(btn => {
            btn.onclick = () => {
                const network = btn.dataset.network;
                openDepositAddressPage(currentDeposit.coin, network);
            };
        });
    }

    function openDepositAddressPage(symbol, network) {
        const addressKey = network.toUpperCase().replace(/\s*\(.*\)/, '').replace(/\s/g, '');
        const address = DEPOSIT_ADDRESSES[addressKey];
        
        if (!address) {
            showMessage(`No deposit address found for ${symbol} on ${network}.`, 'error');
            return;
        }

        currentDeposit.network = network;
        currentDeposit.address = address;
        
        document.getElementById('depositNetworkHeader').textContent = network;
        document.getElementById('depositAddressDisplay').textContent = address;
        document.getElementById('depositAmountInput').value = '';

        // Generate QR code
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: address,
            width: 160,
            height: 160,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        showPage('depositAddressPage');
    }

    function copyDepositAddress() {
        const address = document.getElementById('depositAddressDisplay').textContent;
        if (!address) return;
        
        // Use document.execCommand('copy') as requested for iframe support
        const tempInput = document.createElement('textarea');
        tempInput.value = address;
        document.body.appendChild(tempInput);
        tempInput.select();
        try {
            document.execCommand('copy');
            showMessage('Address Copied', 'Address copied to clipboard!', 'success');
        } catch (err) {
            showMessage('Copy Failed', 'Failed to copy address. Copy manually.', 'error');
        }
        document.body.removeChild(tempInput);
    }

    function showDepositConfirmationPage() {
        const amount = parseFloat(document.getElementById('depositAmountInput').value);
        if (isNaN(amount) || amount <= 0) {
            showMessage('Invalid Amount', 'Please enter a valid deposit amount.', 'error');
            return;
        }
        currentDeposit.amount = amount;
        document.getElementById('depositConfirmAmount').textContent = amount.toFixed(2);
        document.getElementById('depositVerificationCode').value = '';
        document.getElementById('depositCodeError').classList.add('hidden');
        showPage('depositConfirmPage');
    }

    async function handleDepositConfirmation() {
        const code = parseInt(document.getElementById('depositVerificationCode').value);
        const errorMsg = document.getElementById('depositCodeError');
        errorMsg.classList.add('hidden');

        if (isNaN(code) || code.toString().length !== 6) {
            errorMsg.textContent = 'Enter your 6-digit verification code.';
            errorMsg.classList.remove('hidden');
            return;
        }
        
        if (usedDepositCodes.has(code)) {
            errorMsg.textContent = 'This verification code has already been used.';
            errorMsg.classList.remove('hidden');
            return;
        }

        showLoading('Processing deposit...');
        await waitFor(15000);
        hideLoading();

        if (!DEPOSIT_CODES.includes(code)) {
            errorMsg.textContent = 'Invalid verification code.';
            errorMsg.classList.remove('hidden');
            return;
        }
        
        usedDepositCodes.add(code);
        
        // Finalize deposit
        appState.balances.totalUSD += currentDeposit.amount;
        appState.balances.tradeUSD += currentDeposit.amount;

        appState.activities.unshift({
            type: 'Deposit',
            desc: `Deposited $${currentDeposit.amount.toFixed(2)} (${currentDeposit.coin}) via ${currentDeposit.network}.`,
            date: new Date().toISOString(),
            status: 'Success'
        });

        saveState();

        const successMessage = `Successfully deposited $${currentDeposit.amount.toFixed(2)} ${currentDeposit.coin}. Your new balance is $${appState.balances.totalUSD.toFixed(2)}.`;
        showMessage('Deposit Successful', successMessage, {
            text: "Add Token",
            handler: () => {
                addTokenToHoldings(currentDeposit.coin, currentDeposit.image);
                showPage('accountDashboard');
            }
        });
        document.getElementById('modalCloseBtn').onclick = () => { hideModal(); showPage('accountDashboard'); };
    }

    function addTokenToHoldings(symbol, image) {
        const coin = allCoins.find(c => c.symbol.toUpperCase() === symbol);
        if (!coin) {
            showMessage("Token Not Found", "Could not find coin data to add holdings.", 'error');
            return;
        }

        const existing = appState.tokens.find(t => t.symbol === symbol);
        if (!existing) {
            appState.tokens.push({
                symbol: coin.symbol.toUpperCase(),
                name: coin.name,
                image: coin.image,
                price: coin.current_price,
            });
            saveState();
            renderTokenHoldings();
            showMessage("Token Added", `${symbol} added to Token Holdings.`, 'success');
        } else {
            showMessage("Token Exists", `${symbol} is already in your Token Holdings.`, 'info');
        }
    }

    async function renderTokenHoldings() {
        const list = document.getElementById('tokenHoldingsList');
        list.innerHTML = '';
        if (appState.tokens.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No tokens added yet.</p>';
            return;
        }

        // Refresh prices
        const symbols = appState.tokens.map(t => t.symbol.toLowerCase());
        try {
            const response = await fetch(`${COINGECKO_API}/simple/price?ids=${symbols.join(',')}&vs_currencies=usd`);
            const prices = await response.json();

            appState.tokens.forEach(token => {
                const id = token.name.toLowerCase().replace(/\s/g, '-');
                const livePrice = prices[id]?.usd || token.price;
                token.price = livePrice;
                
                list.innerHTML += `
                    <div class="flex items-center justify-between py-2 border-b border-gray-800">
                        <div class="flex items-center gap-2">
                            <img src="${token.image}" class="w-6 h-6 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/24x24/1f2937/ffffff?text=${token.symbol.substring(0,2)}'"/>
                            <span class="font-semibold">${token.symbol}</span>
                        </div>
                        <span class="font-mono text-mt5-green">$${livePrice.toFixed(4)}</span>
                    </div>
                `;
            });
            saveState();
        } catch(e) {
            console.warn("Could not fetch live token prices:", e);
        }
    }

    // =========================================================================
    // 8. WITHDRAWAL SYSTEM
    // =========================================================================

    let currentWithdrawalDetails = {};
    const WITHDRAW_NETWORKS = ['Ethereum', 'Bitcoin', 'BSC', 'Tron'];

    function renderWithdrawalStatus() {
        const statusDiv = document.getElementById('withdrawalStatus');
        const button = document.getElementById('withdrawButton');
        
        const now = Date.now();
        const isSuspended = appState.withdraw.isSuspended && now < appState.withdraw.suspensionEndTime;

        if (isSuspended) {
            const remainingMs = appState.withdraw.suspensionEndTime - now;
            statusDiv.className = 'bg-red-900 p-3 rounded-lg text-sm text-white';
            statusDiv.innerHTML = `<i class="ph-warning-bold mr-2"></i> Withdrawal Suspended. Time Remaining: <span class="font-mono">${formatTime(remainingMs)}</span>`;
            button.disabled = true;
            button.textContent = "Withdrawal Suspended";
        } else {
            // Reset suspension state if time is up
            if (appState.withdraw.isSuspended) {
                appState.withdraw.isSuspended = false;
                appState.withdraw.attemptCount = 0;
                saveState();
            }
            statusDiv.className = 'bg-gray-800 p-3 rounded-lg text-sm text-gray-400';
            statusDiv.innerHTML = `<i class="ph-info-bold mr-2"></i> You have ${5 - appState.withdraw.attemptCount} attempts remaining.`;
            button.disabled = false;
            button.textContent = "Withdraw";
        }

        document.getElementById('selectedWithdrawNetwork').textContent = 'Select Network';
        document.getElementById('withdrawAddress').value = '';
        document.getElementById('withdrawAmount').value = '';
    }

    function selectWithdrawNetwork(network) {
        document.getElementById('selectedWithdrawNetwork').textContent = network;
        currentWithdrawalDetails.network = network;
        toggleMenu('withdrawNetworkDropdown');
    }

    function fillAddressFromConnectedWallet() {
        if (appState.walletAddress) {
            document.getElementById('withdrawAddress').value = appState.walletAddress;
            showMessage("Address Filled", `Connected wallet address filled successfully.`, 'success');
        } else {
            showMessage("No Connected Wallet", "Please log in with a connected wallet first.", 'error');
        }
    }

    function setMaxWithdrawAmount() {
        // Exclude 0.114 BNB gas fee (approx $30 USD mock for simplicity)
        const maxAmount = Math.max(0, appState.balances.tradeUSD - 30);
        document.getElementById('withdrawAmount').value = maxAmount.toFixed(2);
    }

    function showWithdrawConfirmationPage() {
        const address = document.getElementById('withdrawAddress').value.trim();
        const network = document.getElementById('selectedWithdrawNetwork').textContent;
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        
        if (!address || network === 'Select Network' || isNaN(amount) || amount <= 0) {
            showMessage('Invalid Details', 'Please fill in a valid address, network, and amount.', 'error');
            return;
        }

        const gasFeeUSD = 30.00; // 0.114 BNB mock USD value
        if (amount + gasFeeUSD > appState.balances.tradeUSD) {
            showMessage('Insufficient Funds', `Withdrawal of $${amount.toFixed(2)} plus gas fee ($${gasFeeUSD.toFixed(2)}) exceeds your available balance ($${appState.balances.tradeUSD.toFixed(2)}).`, 'error');
            return;
        }

        currentWithdrawalDetails = {
            address, network, amount, gasFee: 0.114, gasFeeUSD,
        };

        document.getElementById('withdrawConfirmAddress').textContent = address;
        document.getElementById('withdrawConfirmNetwork').textContent = network;
        document.getElementById('withdrawConfirmAmount').textContent = amount.toFixed(2);
        document.getElementById('withdrawVerificationCode').value = '';
        document.getElementById('withdrawCodeError').classList.add('hidden');
        showPage('withdrawConfirmPage');
    }

    async function handleWithdrawConfirmation() {
        const code = document.getElementById('withdrawVerificationCode').value.trim();
        const errorMsg = document.getElementById('withdrawCodeError');
        errorMsg.classList.add('hidden');

        if (!code || code.length !== 6) {
            errorMsg.textContent = 'Please enter the 6-digit validation code.';
            errorMsg.classList.remove('hidden');
            appState.withdraw.attemptCount++;
            saveState();
            renderWithdrawalStatus(); // Update attempt count
            return;
        }

        if (usedWithdrawCodes.has(code)) {
            errorMsg.textContent = 'This validation code has already been used.';
            errorMsg.classList.remove('hidden');
            return;
        }

        showLoading('Validating Code...');
        await waitFor(15000);
        hideLoading();

        if (VALID_WITHDRAW_CODES.includes(code)) {
            usedWithdrawCodes.add(code);
            appState.withdraw.attemptCount = 0; // Reset attempts on success
            
            // Start the 24-hour countdown
            const now = Date.now();
            const withdrawalEndTime = now + 24 * 3600 * 1000;
            
            appState.withdraw.currentWithdrawal = {
                ...currentWithdrawalDetails,
                id: crypto.randomUUID(),
                status: 'PROCESSING',
                startTime: now,
                endTime: withdrawalEndTime
            };
            appState.withdraw.countdownEndTime = withdrawalEndTime;
            
            appState.activities.unshift({
                type: 'Withdrawal',
                desc: `Withdrawal of $${currentWithdrawalDetails.amount.toFixed(2)} to ${currentWithdrawalDetails.address} processing.`,
                date: new Date().toISOString(),
                status: 'Processing (24h)'
            });
            saveState();
            
            // Redirect to processing page
            setupWithdrawalProcessingPage(appState.withdraw.currentWithdrawal);
            showPage('withdrawalProcessingPage');

        } else {
            appState.withdraw.attemptCount++;
            errorMsg.textContent = 'Incorrect validation code.';
            errorMsg.classList.remove('hidden');

            if (appState.withdraw.attemptCount >= 5) {
                appState.withdraw.isSuspended = true;
                appState.withdraw.suspensionEndTime = Date.now() + 48 * 3600 * 1000; // 48-hour suspension
                showMessage('Suspension', '5 failed attempts. Withdrawal function suspended for 48 hours.', 'error');
            }
            saveState();
            renderWithdrawalStatus();
        }
    }

    function setupWithdrawalProcessingPage(withdrawal) {
        document.getElementById('processingAddress').textContent = withdrawal.address;
        document.getElementById('processingNetwork').textContent = withdrawal.network;
        document.getElementById('processingAmount').textContent = withdrawal.amount.toFixed(2);
        // Countdown display is updated by the global interval timer
    }

    function finalizeWithdrawal(withdrawal) {
        // Deduct balance and fees
        appState.balances.totalUSD -= (withdrawal.amount + withdrawal.gasFeeUSD);
        appState.balances.tradeUSD -= (withdrawal.amount + withdrawal.gasFeeUSD);
        
        // Log success
        appState.activities.unshift({
            type: 'Withdrawal',
            desc: `Withdrawal of $${withdrawal.amount.toFixed(2)} successful. Fee: $${withdrawal.gasFeeUSD.toFixed(2)}.`,
            date: new Date().toISOString(),
            status: 'Successful'
        });
        
        // Reset withdrawal state
        appState.withdraw.countdownEndTime = 0;
        appState.withdraw.currentWithdrawal = null;
        
        saveState();

        // Show pop-up success banner
        showBanner(`Withdrawal Successful: $${withdrawal.amount.toFixed(2)} to ${withdrawal.address.substring(0, 10)}...`);
    }

    // =========================================================================
    // 9. SECURITY (2FA)
    // =========================================================================

    function setupGoogleAuthPage() {
        if (!appState.isAuthenticated) return;
        
        document.getElementById('authAccountIdDisplay').textContent = appState.accountId;
        document.getElementById('authCodeError').classList.add('hidden');
        document.getElementById('authVerificationCode').value = '';

        if (!appState.twoFA.secret) {
            // Generate new secret
            appState.twoFA.secret = otplib.authenticator.generateSecret();
            saveState();
        }

        const secret = appState.twoFA.secret;
        const issuer = 'MT5 Trader';
        const user = appState.accountId;
        
        // Generate QR code URI
        const otpauth = otplib.authenticator.keyuri(user, issuer, secret);

        document.getElementById('authSecretKey').textContent = secret;
        
        // Generate QR code
        const qrContainer = document.getElementById('authQrCode');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: otpauth,
            width: 180,
            height: 180,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    }

    function copySecretKey() {
        const key = document.getElementById('authSecretKey').textContent;
        if (!key) return;
        
        const tempInput = document.createElement('textarea');
        tempInput.value = key;
        document.body.appendChild(tempInput);
        tempInput.select();
        try {
            document.execCommand('copy');
            showMessage('Secret Copied', 'Secret key copied to clipboard!', 'success');
        } catch (err) {
            showMessage('Copy Failed', 'Failed to copy key. Copy manually.', 'error');
        }
        document.body.removeChild(tempInput);
    }

    async function verifyAuthCode() {
        const code = document.getElementById('authVerificationCode').value.trim();
        const errorMsg = document.getElementById('authCodeError');
        errorMsg.classList.add('hidden');
        
        if (!code || code.length !== 6) {
            errorMsg.textContent = 'Please enter a 6-digit code.';
            errorMsg.classList.remove('hidden');
            return;
        }

        showLoading('Verifying Code...');
        await waitFor(5000); // Simulate network delay for verification
        
        const secret = appState.twoFA.secret;
        const isValid = otplib.authenticator.check(code, secret);

        hideLoading();

        if (isValid) {
            appState.twoFA.enabled = true;
            saveState();
            showMessage("2FA Enabled", "Google Authenticator successfully linked to your account!", 'success', {
                text: "Back to Dashboard",
                handler: () => showPage('accountDashboard')
            });
        } else {
            errorMsg.textContent = 'Invalid code. Please try again.';
            errorMsg.classList.remove('hidden');
        }
    }

    // =========================================================================
    // 10. NOTIFICATIONS & NEWS
    // =========================================================================

    function toggleNotifications() {
        appState.notifications.enabled = document.getElementById('notificationToggle').checked;
        saveState();
        showMessage("Notifications Updated", `Notifications are now ${appState.notifications.enabled ? 'ON' : 'OFF'}.`, 'info');
    }

    async function fetchMarketNews() {
        if (!appState.notifications.enabled) return;

        try {
            // Fetch top 10 trending coins as mock news
            const response = await fetch(`${COINGECKO_API}/search/trending`);
            if (!response.ok) throw new Error('Failed to fetch trending coins.');
            const data = await response.json();

            const news = data.coins.slice(0, 5).map(item => ({
                title: `${item.item.symbol} is trending!`,
                body: `Rank #${item.item.market_cap_rank || 'N/A'}. Score: ${item.item.score}.`,
                date: new Date().toISOString()
            }));

            appState.notifications.dailyNews = news;
            saveState();

            // Render on news page
            const list = document.getElementById('newsList');
            list.innerHTML = '';
            news.forEach(n => {
                list.innerHTML += `
                    <div class="trading-data-card p-4 rounded-xl shadow-md">
                        <p class="font-bold text-mt5-accent">${n.title}</p>
                        <p class="text-gray-300 text-sm mt-1">${n.body}</p>
                        <p class="text-xs text-gray-500 mt-2">${new Date(n.date).toLocaleString()}</p>
                    </div>
                `;
            });

        } catch (error) {
            console.error("Error fetching news:", error);
            document.getElementById('newsList').innerHTML = '<p class="text-center text-red-500 py-4">Failed to load market news.</p>';
        }
    }

    function showBanner(message) {
        const banner = document.getElementById('notificationBanner');
        document.getElementById('bannerMessage').textContent = message;
        banner.classList.remove('hidden', '-translate-y-full');
        banner.classList.add('translate-y-0');
        setTimeout(() => hideBanner(), 10000);
    }

    function hideBanner() {
        const banner = document.getElementById('notificationBanner');
        banner.classList.remove('translate-y-0');
        banner.classList.add('-translate-y-full');
        // Hide completely after transition
        setTimeout(() => banner.classList.add('hidden'), 500);
    }

    function checkBannerDisplay() {
        if (!appState.notifications.enabled) return;
        const now = Date.now();
        const twelveHours = 12 * 3600 * 1000;

        if (now - appState.notifications.lastBannerTime > twelveHours) {
            fetchMarketNews(); // Update news before showing banner
            if (appState.notifications.dailyNews.length > 0) {
                const latestNews = appState.notifications.dailyNews[0];
                showBanner(`[Daily Update] ${latestNews.title}`);
                appState.notifications.lastBannerTime = now;
                saveState();
            }
        }
    }

    // =========================================================================
    // 11. HISTORY & USER DETAILS
    // =========================================================================

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if (appState.activities.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-center py-4">No activity logged yet.</p>';
            return;
        }

        appState.activities.forEach(activity => {
            const date = new Date(activity.date).toLocaleString();
            let color = activity.status === 'Success' ? 'text-mt5-green' : 'text-mt5-red';
            if (activity.type === 'Trade') color = 'text-mt5-accent';
            
            list.innerHTML += `
                <div class="border-b border-gray-700 py-2">
                    <p class="font-bold ${color}">${activity.type} - ${activity.status}</p>
                    <p class="text-xs text-gray-500">${date}</p>
                    <p class="text-sm text-gray-400">${activity.desc}</p>
                </div>
            `;
        });
    }

    function renderUserDetails() {
        document.getElementById('profileAccountId').textContent = appState.accountId;
        document.getElementById('profileWalletAddress').textContent = appState.walletAddress;
        document.getElementById('profileNetwork').textContent = appState.network;
        document.getElementById('profileBalance').textContent = `$${appState.balances.totalUSD.toFixed(2)}`;
    }

    // =========================================================================
    // 12. GLOBAL TIMER & LIFECYCLE
    // =========================================================================

    function globalTimer() {
        const now = Date.now();

        // 1. Trade Return Calculation
        calculateTradeReturns();

        // 2. Withdrawal Countdown Logic
        const countdownElement = document.getElementById('countdownDisplay');
        if (appState.withdraw.countdownEndTime > 0 && now < appState.withdraw.countdownEndTime) {
            const remaining = appState.withdraw.countdownEndTime - now;
            const timeStr = formatTime(remaining);
            if (countdownElement) countdownElement.textContent = timeStr;
            // Also show banner on main view if active
            if (appState.currentView !== 'withdrawalProcessingPage') {
                 // Update header suspension banner
                const suspensionBanner = document.getElementById('withdrawalSuspensionBanner');
                if (suspensionBanner) {
                    suspensionBanner.classList.remove('hidden');
                    document.getElementById('suspensionCountdown').textContent = `Processing: ${timeStr}`;
                }
            }
        } else if (appState.withdraw.countdownEndTime > 0 && now >= appState.withdraw.countdownEndTime) {
            finalizeWithdrawal(appState.withdraw.currentWithdrawal);
            if (countdownElement) countdownElement.textContent = "00:00:00 - Successful!";
        }

        // 3. Suspension Countdown Logic (Updated by renderWithdrawalStatus on page load)
        if (appState.withdraw.isSuspended && now < appState.withdraw.suspensionEndTime) {
            const remaining = appState.withdraw.suspensionEndTime - now;
            const suspensionBanner = document.getElementById('withdrawalSuspensionBanner');
            if (suspensionBanner) {
                suspensionBanner.classList.remove('hidden');
                document.getElementById('suspensionCountdown').textContent = `Suspended: ${formatTime(remaining)}`;
            }
        } else {
            const suspensionBanner = document.getElementById('withdrawalSuspensionBanner');
            if (suspensionBanner) suspensionBanner.classList.add('hidden');
        }

        // 4. Trade Pause Resumption
        appState.openTrades.forEach(trade => {
            if (trade.status === 'PAUSED' && trade.resumeTime <= now) {
                trade.status = 'OPEN';
                delete trade.resumeTime;
                showMessage("Trade Resumed", `${trade.symbol} trade has resumed after 24-hour pause.`, 'success');
                saveState();
            }
        });
        
        // 5. Notification Banner Check
        checkBannerDisplay();
    }

    // Global interval setup
    setInterval(globalTimer, 1000);

    // =========================================================================
    // 13. THEME LOGIC
    // =========================================================================

    function toggleTheme() {
        const isDark = document.getElementById('themeToggle').checked;
        appState.theme = isDark ? 'dark' : 'light';
        saveState();
        applyTheme();
        if (appState.currentView === 'chartsPage' && tvWidget) {
            // Re-load chart to apply theme change
            loadTradingViewChart(appState.currentSymbol);
        }
    }

    function applyTheme() {
        const isDark = appState.theme === 'dark';
        document.body.style.backgroundColor = isDark ? 'var(--mt5-bg-dark)' : '#f3f4f6';
        document.body.style.color = isDark ? '#f0f0f0' : '#1f2937';
    
        // Update elements that need explicit class manipulation for light mode
        document.querySelectorAll('.trading-data-card').forEach(el => {
            if (isDark) {
                el.classList.remove('bg-white', 'text-gray-800');
                el.classList.add('bg-[#1c1c27]', 'text-white');
            } else {
                el.classList.remove('bg-[#1c1c27]', 'text-white');
                el.classList.add('bg-white', 'text-gray-800');
            }
        });

        // Update checkbox state
        document.getElementById('themeToggle').checked = isDark;
    }

    // =========================================================================
    // 14. INITIALIZATION
    // =========================================================================

    window.onload = function() {
        loadState();
        applyTheme();
        document.getElementById('notificationToggle').checked = appState.notifications.enabled;
        checkAuth();
        globalTimer(); // Run immediately to update timers/suspensions
    };

    // Global click listener to hide menus on body click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#moreMenuBtn')) {
            document.getElementById('moreMenuDropdown').classList.add('hidden');
        }
        if (!e.target.closest('#networkSelectorBtn')) {
            document.getElementById('networkDropdownCreation').classList.add('hidden');
        }
        if (!e.target.closest('#networkSelectorBtnLogin')) {
            document.getElementById('networkDropdownLogin').classList.add('hidden');
        }
        if (!e.target.closest('#withdrawNetworkSelectorBtn')) {
            document.getElementById('withdrawNetworkDropdown').classList.add('hidden');
        }
    });

</script>
</body>
</html>
